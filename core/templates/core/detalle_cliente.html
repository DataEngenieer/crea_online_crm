{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="px-0">
    <!-- Resumen Superior -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body d-flex flex-wrap align-items-center detalle-cliente-header-custom">
            <div class="flex-grow-1">
                <h3 class="mb-1">{{ cliente_representativo.nombre_completo|default:"Cliente sin nombre" }}</h3>
                <div class="mb-2 text-muted fs-6">
                    <i class="bi bi-credit-card"></i> {{ documento_cliente|default:"N/A" }} &nbsp;|&nbsp;
                    <i class="bi bi-geo-alt"></i> {{ cliente_representativo.ciudad|default:"N/A" }} &nbsp;|&nbsp;
                    <i class="bi bi-phone"></i> {{ cliente_representativo.celular_1|default:"N/A" }} &nbsp;
                    
                    {% comment %}Lógica para determinar el estado de negociación{% endcomment %}
                    {% with ultimo_acuerdo=gestiones_cliente|dictsortreversed:'fecha_hora_gestion'|first %}
                        {% if ultimo_acuerdo and ultimo_acuerdo.acuerdo_pago_realizado %}
                            {% if ultimo_acuerdo.fecha_acuerdo and ultimo_acuerdo.fecha_acuerdo < today %}
                                <span class="badge bg-warning ms-2" title="Acuerdo de pago vencido"><i class="bi bi-exclamation-triangle me-1"></i>Acuerdo Vencido</span>
                            {% else %}
                                <span class="badge bg-success ms-2" title="Acuerdo de pago vigente"><i class="bi bi-check-circle me-1"></i>Con Acuerdo</span>
                            {% endif %}
                        {% elif gestiones_cliente %}
                            <span class="badge bg-info ms-2" title="En proceso de negociación"><i class="bi bi-arrow-repeat me-1"></i>En Negociación</span>
                        {% elif cliente_representativo.estado == 'Activo' %}
                            <span class="badge bg-primary ms-2" title="Cliente activo, sin gestión"><i class="bi bi-person-check me-1"></i>Sin Gestión</span>
                        {% else %}
                            <span class="badge bg-{% if cliente_representativo.estado == 'Activo' %}success{% elif cliente_representativo.estado == 'Inactivo' %}danger{% else %}secondary{% endif %} ms-2">{{ cliente_representativo.estado|default:"N/A" }}</span>
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
            <div class="mt-2 mt-md-0">
                <a href="https://wa.me/{{ cliente_representativo.celular_1|default:'' }}" target="_blank" class="btn btn-success btn-sm me-1"><i class="bi bi-whatsapp"></i> WhatsApp</a>
                <a href="sms:{{ cliente_representativo.celular_1|default:'' }}" class="btn btn-info btn-sm me-1 text-white"><i class="bi bi-chat-text-fill"></i> SMS</a>
                <a href="tel:{{ cliente_representativo.celular_1|default:'' }}" class="btn btn-warning btn-sm me-1"><i class="bi bi-telephone"></i> Llamar</a>
                <a href="mailto:{{ cliente_representativo.email|default:'' }}" class="btn btn-secondary btn-sm me-1"><i class="bi bi-envelope"></i> Email</a>
                <a href="{% url 'clientes' %}" class="btn btn-light me-1"><i class="bi bi-arrow-left"></i> Volver a Clientes</a>
            </div>
        </div>
    </div>

    <!-- Tabs para secciones -->
    <ul class="nav nav-tabs mb-0" id="clienteTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="financiera-consolidada-tab" data-bs-toggle="tab" data-bs-target="#financiera-consolidada" type="button" role="tab" aria-controls="financiera-consolidada" aria-selected="true">Información Financiera</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="info-contacto-tab" data-bs-toggle="tab" data-bs-target="#info-contacto" type="button" role="tab" aria-controls="info-contacto" aria-selected="false">Información Detallada y Contactos</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="registrar-gestion-tab" data-bs-toggle="tab" data-bs-target="#registrar-gestion" type="button" role="tab" aria-controls="registrar-gestion" aria-selected="false">Registrar Gestión</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="historial-gestiones-tab" data-bs-toggle="tab" data-bs-target="#historial-gestiones" type="button" role="tab" aria-controls="historial-gestiones" aria-selected="false">Historial de Gestiones</button>
        </li>
    </ul>

    <div class="tab-content" id="clienteTabContent">
        <!-- Pestaña: Información Financiera Consolidada (Unificada con Lista de Productos) -->
        <div class="tab-pane fade show active" id="financiera-consolidada" role="tabpanel" aria-labelledby="financiera-consolidada-tab">
            <div class="card card-body shadow-sm border-top-0 rounded-bottom p-3">
                <!-- Encabezado del panel financiero -->
                <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-currency-dollar me-2 text-success"></i>Información Financiera y Productos
                    </h5>
                    <span class="badge bg-primary">Documento: {{ documento_cliente }} | Total: {{ referencias_cliente|length }} productos</span>
                </div>
                
                <!-- Resumen financiero en tarjetas -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100 bg-light">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="rounded-circle bg-success p-2 me-2">
                                        <i class="bi bi-cash text-white"></i>
                                    </div>
                                    <h6 class="mb-0">Principal Total</h6>
                                </div>
                                <div class="display-6 text-success fw-bold">${{ saldo_capital_total|intcomma|default:'0' }}</div>
                                <div class="small text-muted mt-2">
                                    <i class="bi bi-info-circle"></i> Capital inicial pendiente
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100 bg-light">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="rounded-circle bg-warning p-2 me-2">
                                        <i class="bi bi-bank text-white"></i>
                                    </div>
                                    <h6 class="mb-0">Valor Pagado</h6>
                                </div>
                                <div class="display-6 text-warning fw-bold">${{ valor_pagado_total|intcomma|default:'0' }}</div>
                                <div class="small text-muted mt-2">
                                    <i class="bi bi-credit-card"></i> Total abonado a la deuda
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100 bg-light">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="rounded-circle bg-primary p-2 me-2">
                                        <i class="bi bi-calculator text-white"></i>
                                    </div>
                                    <h6 class="mb-0">Deuda Total Consolidada</h6>
                                </div>
                                <div class="display-6 text-primary fw-bold">${{ deuda_total_consolidada|intcomma|default:'0' }}</div>
                                <div class="small text-muted mt-2">
                                    <i class="bi bi-graph-up-arrow"></i> Incluye capital + intereses + otros cargos
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Pestañas internas: Tabla y Detalle -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <ul class="nav nav-tabs card-header-tabs" id="productos-tab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="tabla-productos-tab" data-bs-toggle="tab" data-bs-target="#tabla-productos" type="button" role="tab" aria-controls="tabla-productos" aria-selected="true">
                                    <i class="bi bi-table me-1"></i>Tabla de Productos
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="detalle-productos-tab" data-bs-toggle="tab" data-bs-target="#detalle-productos" type="button" role="tab" aria-controls="detalle-productos" aria-selected="false">
                                    <i class="bi bi-card-list me-1"></i>Detalle por Producto
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body p-0">
                        <div class="tab-content" id="productos-tabContent">
                            <!-- Tabla de Productos -->
                            <div class="tab-pane fade show active p-3" id="tabla-productos" role="tabpanel" aria-labelledby="tabla-productos-tab">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover table-striped table-bordered" style="font-size: 0.85rem;">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Ref.</th>
                                                <th>Nombre Completo</th>
                                                <th>F. Cesión</th>
                                                <th>F. Registro</th>
                                                <th>F. Act.</th>
                                                <th>Estado</th>
                                                <th class="text-end">Principal</th>
                                                <th class="text-end">Deuda Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ref in referencias_cliente %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-info">
                                                        <i class="bi bi-tag-fill me-1"></i>{{ ref.referencia|default:'N/A' }}
                                                    </span>
                                                </td>
                                                <td>{{ ref.nombre_completo|truncatechars:30|default:'N/A' }}</td>
                                                <td>{{ ref.fecha_cesion|date:'d M Y'|default:'N/A' }}</td>
                                                <td>{{ ref.fecha_registro|date:'d M Y'|default:'N/A' }}</td>
                                                <td>{{ ref.fecha_act|date:'d M Y'|default:'N/A' }}</td>
                                                <td class="text-center">
                                                    <span class="badge bg-{% if ref.estado == 'Activo' %}success{% elif ref.estado == 'Inactivo' %}danger{% else %}secondary{% endif %}">
                                                        <i class="bi bi-circle-fill me-1"></i>{{ ref.estado|default:'N/A' }}
                                                    </span>
                                                </td>
                                                <td class="text-end fw-bold">${{ ref.principal|intcomma|default:'0' }}</td>
                                                <td class="text-end fw-bold">${{ ref.deuda_total|intcomma|default:'0' }}</td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="8" class="text-center text-muted py-3">
                                                    <i class="bi bi-exclamation-circle me-2"></i>No hay referencias para este cliente.
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Detalle por Producto -->
                            <div class="tab-pane fade p-3" id="detalle-productos" role="tabpanel" aria-labelledby="detalle-productos-tab">
                                <div class="accordion accordion-flush" id="accordionProductos">
                                    {% if referencias_cliente %}
                                        {% for ref in referencias_cliente %}
                                        <div class="accordion-item border mb-2 rounded">
                                            <h2 class="accordion-header" id="heading-producto-{{ ref.id }}">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-producto-{{ ref.id }}" aria-expanded="false" aria-controls="collapse-producto-{{ ref.id }}">
                                                    <i class="bi bi-tag-fill me-2 text-primary"></i>
                                                    <strong>{{ ref.referencia|default:'N/A' }}</strong>
                                                    <span class="ms-2 badge bg-{% if ref.estado == 'Activo' %}success{% elif ref.estado == 'Inactivo' %}danger{% else %}secondary{% endif %}">
                                                        {{ ref.estado|default:'N/A' }}
                                                    </span>
                                                    <span class="ms-auto me-3 text-primary fw-bold">${{ ref.deuda_total|intcomma|default:'0' }}</span>
                                                </button>
                                            </h2>
                                            <div id="collapse-producto-{{ ref.id }}" class="accordion-collapse collapse" aria-labelledby="heading-producto-{{ ref.id }}">
                                                <div class="accordion-body">
                                                    <div class="row g-3">
                                                        <div class="col-md-6">
                                                            <div class="card h-100 border-0 shadow-sm">
                                                                <div class="card-header bg-light d-flex align-items-center">
                                                                    <i class="bi bi-cash-coin me-2 text-success"></i>
                                                                    <h6 class="mb-0">Información Financiera</h6>
                                                                </div>
                                                                <div class="card-body p-3">
                                                                    <div class="row g-2">
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">Principal:</span>
                                                                                <span class="fw-bold">${{ ref.principal|intcomma|default:'0' }}</span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">Deuda Total:</span>
                                                                                <span class="fw-bold text-primary">${{ ref.deuda_total|intcomma|default:'0' }}</span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">Días Mora:</span>
                                                                                <span class="fw-bold text-danger">{{ ref.dias_mora_caso_sas|default:'0' }}</span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">Estado:</span>
                                                                                <span class="badge bg-{% if ref.estado == 'Activo' %}success{% elif ref.estado == 'Inactivo' %}danger{% else %}secondary{% endif %}">
                                                                                    {{ ref.estado|default:'N/A' }}
                                                                                </span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="card h-100 border-0 shadow-sm">
                                                                <div class="card-header bg-light d-flex align-items-center">
                                                                    <i class="bi bi-calendar-date me-2 text-info"></i>
                                                                    <h6 class="mb-0">Fechas y Datos Adicionales</h6>
                                                                </div>
                                                                <div class="card-body p-3">
                                                                    <div class="row g-2">
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">F. Cesión:</span>
                                                                                <span>{{ ref.fecha_cesion|date:'d M Y'|default:'N/A' }}</span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">F. Registro:</span>
                                                                                <span>{{ ref.fecha_registro|date:'d M Y'|default:'N/A' }}</span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">F. Act.:</span>
                                                                                <span>{{ ref.fecha_act|date:'d M Y'|default:'N/A' }}</span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">Cliente:</span>
                                                                                <span>{{ ref.nombre_completo|truncatechars:25|default:'N/A' }}</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="alert alert-info" role="alert">
                                            <i class="bi bi-info-circle-fill me-2"></i>No hay referencias disponibles para mostrar detalles.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pestaña: Información General (del cliente_representativo) y Contactos -->
        <div class="tab-pane fade" id="info-contacto" role="tabpanel" aria-labelledby="info-contacto-tab">
            <div class="card card-body shadow-sm border-top-0 rounded-bottom p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title mb-0"><i class="bi bi-info-circle me-1"></i>Información Detallada y Contactos</h5>
                </div>

                <!-- Datos Generales - Formato compacto -->
                <div class="mb-2 p-2 border rounded bg-light">
                    <div class="d-flex align-items-center mb-1">
                        <i class="bi bi-person-badge me-1"></i>
                        <h6 class="mb-0 fs-6">Datos Generales</h6>
                    </div>
                    <div class="row g-1">
                        <div class="col-md-4 mb-1">
                            <div class="d-flex align-items-center">
                                <span class="text-muted me-1" style="width: 110px; font-size: 0.85rem;">Tipo Documento:</span>
                                <span class="badge bg-secondary">{{ cliente_representativo.tipo_documento|default:'N/A' }}</span>
                            </div>
                        </div>
                        <div class="col-md-4 mb-1">
                            <div class="d-flex align-items-center">
                                <span class="text-muted me-1" style="width: 110px; font-size: 0.85rem;">Nombre:</span>
                                <span>{{ cliente_representativo.nombre_completo|default:'N/A' }}</span>
                            </div>
                        </div>
                        <div class="col-md-4 mb-1">
                            <div class="d-flex align-items-center">
                                <span class="text-muted me-1" style="width: 110px; font-size: 0.85rem;">Ciudad:</span>
                                <span>{{ cliente_representativo.ciudad|default:'N/A' }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información de productos -->
                <div class="accordion accordion-flush" id="accordionContactosProductos">
                    {% if referencias_cliente %}
                        {% for ref in referencias_cliente %}
                        <div class="accordion-item border mb-1 rounded">
                            <h2 class="accordion-header" id="heading-{{ ref.id }}">
                                <button class="accordion-button collapsed p-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ ref.id }}" aria-expanded="false" aria-controls="collapse-{{ ref.id }}">
                                    <i class="bi bi-tag-fill me-1 text-primary"></i>
                                    <strong>{{ ref.referencia|default:'N/A' }}</strong>
                                    <span class="ms-2 text-muted small">{{ ref.nombre_completo|truncatechars:30|default:'Cliente' }}</span>
                                </button>
                            </h2>
                            <div id="collapse-{{ ref.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ ref.id }}">
                                <div class="accordion-body p-2">
                                    <div class="row g-0">
                                        <!-- Contactos -->
                                        <div class="col-md-6 p-1">
                                            <div class="border-start border-primary ps-2 mb-1" style="border-left-width: 3px !important;">
                                                <span class="fw-bold text-primary"><i class="bi bi-telephone-fill me-1"></i>Contactos</span>
                                            </div>
                                            <div class="row g-0">
                                                <div class="col-lg-6 p-1">
                                                    <div class="d-flex align-items-center">
                                                        <span class="text-muted me-1" style="width: 70px; font-size: 0.8rem;">Celular 1:</span>
                                                        <a href="tel:{{ ref.celular_1 }}" class="ms-1 badge bg-warning text-dark">{{ ref.celular_1|default:'N/A' }}</a>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 p-1">
                                                    <div class="d-flex align-items-center">
                                                        <span class="text-muted me-1" style="width: 70px; font-size: 0.8rem;">Celular 2:</span>
                                                        <span>{{ ref.celular_2|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 p-1">
                                                    <div class="d-flex align-items-center">
                                                        <span class="text-muted me-1" style="width: 70px; font-size: 0.8rem;">Celular 3:</span>
                                                        <span>{{ ref.celular_3|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 p-1">
                                                    <div class="d-flex align-items-center">
                                                        <span class="text-muted me-1" style="width: 70px; font-size: 0.8rem;">Teléfono:</span>
                                                        <span>{{ ref.telefono_1|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 p-1">
                                                    <div class="d-flex align-items-center">
                                                        <span class="text-muted me-1" style="width: 70px; font-size: 0.8rem;">Teléfono 2:</span>
                                                        <span>{{ ref.telefono_2|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 p-1">
                                                    <div class="d-flex align-items-center">
                                                        <span class="text-muted me-1" style="width: 70px; font-size: 0.8rem;">Email:</span>
                                                        <span>{{ ref.email|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Direcciones -->
                                        <div class="col-md-6 p-1">
                                            <div class="border-start border-success ps-2 mb-1" style="border-left-width: 3px !important;">
                                                <span class="fw-bold text-success"><i class="bi bi-geo-alt-fill me-1"></i>Direcciones</span>
                                            </div>
                                            <div class="row g-0">
                                                <div class="col-12 p-1">
                                                    <div class="d-flex">
                                                        <span class="text-muted me-1" style="min-width: 30px; font-size: 0.8rem;">1:</span>
                                                        <span style="font-size: 0.85rem;">{{ ref.direccion_1|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-12 p-1">
                                                    <div class="d-flex">
                                                        <span class="text-muted me-1" style="min-width: 30px; font-size: 0.8rem;">2:</span>
                                                        <span style="font-size: 0.85rem;">{{ ref.direccion_2|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-12 p-1">
                                                    <div class="d-flex">
                                                        <span class="text-muted me-1" style="min-width: 30px; font-size: 0.8rem;">3:</span>
                                                        <span style="font-size: 0.85rem;">{{ ref.direccion_3|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-12 p-1">
                                                    <div class="d-flex">
                                                        <span class="text-muted me-1" style="min-width: 30px; font-size: 0.8rem;">4:</span>
                                                        <span style="font-size: 0.85rem;">{{ ref.direccion_4|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted mt-2">No hay referencias para este cliente.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Pestaña: Registrar Gestión -->
        <div class="tab-pane fade" id="registrar-gestion" role="tabpanel" aria-labelledby="registrar-gestion-tab">
            <div class="card card-body shadow-sm border-top-0 rounded-bottom p-3">
                <!-- Encabezado del formulario -->
                <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-headset me-2 text-primary"></i>Registrar Nueva Gestión
                    </h5>
                    <span class="badge bg-primary">Cliente: {{ cliente_representativo.nombre_completo }}</span>
                </div>
                
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    {{ gestion_form.cliente }} {# Campo oculto #}
                    
                    <!-- Secciones del formulario con tarjetas -->
                    <div class="row g-3">
                        <!-- Sección 1: Información del Contacto -->
                        <div class="col-md-4">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-light d-flex align-items-center">
                                    <i class="bi bi-telephone-fill me-2 text-primary"></i>
                                    <h6 class="mb-0">Información del Contacto</h6>
                                </div>
                                <div class="card-body p-3">
                                    <!-- Canal de contacto con iconos -->
                                    <div class="mb-3">
                                        <label for="{{ gestion_form.canal_contacto.id_for_label }}" class="form-label d-flex align-items-center">
                                            <i class="bi bi-broadcast me-1 text-primary"></i>
                                            <span>{{ gestion_form.canal_contacto.label }}</span>
                                        </label>
                                        {{ gestion_form.canal_contacto }}
                                        {% if gestion_form.canal_contacto.errors %}<div class="invalid-feedback d-block">{{ gestion_form.canal_contacto.errors|join:", " }}</div>{% endif %}
                                    </div>
                                    
                                    <!-- Estado de contacto -->
                                    <div class="mb-3">
                                        <label for="{{ gestion_form.estado_contacto.id_for_label }}" class="form-label d-flex align-items-center">
                                            <i class="bi bi-reception-4 me-1 text-primary"></i>
                                            <span>{{ gestion_form.estado_contacto.label }}</span>
                                        </label>
                                        {{ gestion_form.estado_contacto }}
                                        {% if gestion_form.estado_contacto.errors %}<div class="invalid-feedback d-block">{{ gestion_form.estado_contacto.errors|join:", " }}</div>{% endif %}
                                    </div>
                                    
                                    <!-- Tipo de gestión N1 -->
                                    <div class="mb-3">
                                        <label for="{{ gestion_form.tipo_gestion_n1.id_for_label }}" class="form-label d-flex align-items-center">
                                            <i class="bi bi-grid-1x2 me-1 text-primary"></i>
                                            <span>{{ gestion_form.tipo_gestion_n1.label }}</span>
                                        </label>
                                        {{ gestion_form.tipo_gestion_n1 }}
                                        {% if gestion_form.tipo_gestion_n1.errors %}<div class="invalid-feedback d-block">{{ gestion_form.tipo_gestion_n1.errors|join:", " }}</div>{% endif %}
                                    </div>
                                    
                                    <!-- Tipo de gestión N2 -->
                                    <div class="mb-3">
                                        <label for="{{ gestion_form.tipo_gestion_n2.id_for_label }}" class="form-label d-flex align-items-center">
                                            <i class="bi bi-grid-3x2 me-1 text-primary"></i>
                                            <span>{{ gestion_form.tipo_gestion_n2.label }}</span>
                                        </label>
                                        {{ gestion_form.tipo_gestion_n2 }}
                                        {% if gestion_form.tipo_gestion_n2.errors %}<div class="invalid-feedback d-block">{{ gestion_form.tipo_gestion_n2.errors|join:", " }}</div>{% endif %}
                                    </div>
                                    
                                    <!-- Tipo de gestión N3 -->
                                    <div class="mb-3">
                                        <label for="{{ gestion_form.tipo_gestion_n3.id_for_label }}" class="form-label d-flex align-items-center">
                                            <i class="bi bi-grid-3x3 me-1 text-primary"></i>
                                            <span>{{ gestion_form.tipo_gestion_n3.label }}</span>
                                        </label>
                                        {{ gestion_form.tipo_gestion_n3 }}
                                        {% if gestion_form.tipo_gestion_n3.errors %}<div class="invalid-feedback d-block">{{ gestion_form.tipo_gestion_n3.errors|join:", " }}</div>{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección 2: Acuerdo de Pago -->
                        <div class="col-md-4">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-light d-flex align-items-center">
                                    <i class="bi bi-cash-coin me-2 text-success"></i>
                                    <h6 class="mb-0">Acuerdo de Pago</h6>
                                </div>
                                <div class="card-body p-3">
                                    <!-- Switch de acuerdo realizado -->
                                    <div class="mb-4 form-check form-switch">
                                        {{ gestion_form.acuerdo_pago_realizado }}
                                        <label for="{{ gestion_form.acuerdo_pago_realizado.id_for_label }}" class="form-check-label fw-bold">
                                            {{ gestion_form.acuerdo_pago_realizado.label }}
                                        </label>
                                        {% if gestion_form.acuerdo_pago_realizado.errors %}<div class="invalid-feedback d-block">{{ gestion_form.acuerdo_pago_realizado.errors|join:", " }}</div>{% endif %}
                                    </div>
                                    
                                    <!-- Campos de acuerdo -->
                                    <div id="campos-acuerdo">
                                        <!-- Fecha de acuerdo -->
                                        <div class="mb-3">
                                            <label for="{{ gestion_form.fecha_acuerdo.id_for_label }}" class="form-label d-flex align-items-center">
                                                <i class="bi bi-calendar-date me-1 text-success"></i>
                                                <span>{{ gestion_form.fecha_acuerdo.label }}</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                                {{ gestion_form.fecha_acuerdo }}
                                            </div>
                                            {% if gestion_form.fecha_acuerdo.errors %}<div class="invalid-feedback d-block">{{ gestion_form.fecha_acuerdo.errors|join:", " }}</div>{% endif %}
                                        </div>
                                        
                                        <!-- Monto de acuerdo -->
                                        <div class="mb-3">
                                            <label for="{{ gestion_form.monto_acuerdo.id_for_label }}" class="form-label d-flex align-items-center">
                                                <i class="bi bi-currency-dollar me-1 text-success"></i>
                                                <span>{{ gestion_form.monto_acuerdo.label }}</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                {{ gestion_form.monto_acuerdo }}
                                            </div>
                                            {% if gestion_form.monto_acuerdo.errors %}<div class="invalid-feedback d-block">{{ gestion_form.monto_acuerdo.errors|join:", " }}</div>{% endif %}
                                        </div>
                                        
                                        <!-- Observaciones de acuerdo -->
                                        <div class="mb-3">
                                            <label for="{{ gestion_form.observaciones_acuerdo.id_for_label }}" class="form-label d-flex align-items-center">
                                                <i class="bi bi-chat-left-text me-1 text-success"></i>
                                                <span>{{ gestion_form.observaciones_acuerdo.label }}</span>
                                            </label>
                                            {{ gestion_form.observaciones_acuerdo }}
                                            {% if gestion_form.observaciones_acuerdo.errors %}<div class="invalid-feedback d-block">{{ gestion_form.observaciones_acuerdo.errors|join:", " }}</div>{% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección 3: Seguimiento y Observaciones -->
                        <div class="col-md-4">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-light d-flex align-items-center">
                                    <i class="bi bi-clipboard-check me-2 text-info"></i>
                                    <h6 class="mb-0">Seguimiento y Observaciones</h6>
                                </div>
                                <div class="card-body p-3">
                                    <!-- Switch de seguimiento requerido -->
                                    <div class="mb-4 form-check form-switch">
                                        {{ gestion_form.seguimiento_requerido }}
                                        <label for="{{ gestion_form.seguimiento_requerido.id_for_label }}" class="form-check-label fw-bold">
                                            {{ gestion_form.seguimiento_requerido.label }}
                                        </label>
                                        {% if gestion_form.seguimiento_requerido.errors %}<div class="invalid-feedback d-block">{{ gestion_form.seguimiento_requerido.errors|join:", " }}</div>{% endif %}
                                    </div>
                                    
                                    <!-- Campos de seguimiento -->
                                    <div id="campos-seguimiento">
                                        <div class="row">
                                            <!-- Fecha de próximo seguimiento -->
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ gestion_form.fecha_proximo_seguimiento.id_for_label }}" class="form-label d-flex align-items-center">
                                                    <i class="bi bi-calendar-week me-1 text-info"></i>
                                                    <span>{{ gestion_form.fecha_proximo_seguimiento.label }}</span>
                                                </label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                                    {{ gestion_form.fecha_proximo_seguimiento }}
                                                </div>
                                                {% if gestion_form.fecha_proximo_seguimiento.errors %}<div class="invalid-feedback d-block">{{ gestion_form.fecha_proximo_seguimiento.errors|join:", " }}</div>{% endif %}
                                            </div>
                                            
                                            <!-- Hora de próximo seguimiento -->
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ gestion_form.hora_proximo_seguimiento.id_for_label }}" class="form-label d-flex align-items-center">
                                                    <i class="bi bi-clock me-1 text-info"></i>
                                                    <span>{{ gestion_form.hora_proximo_seguimiento.label }}</span>
                                                </label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="bi bi-clock"></i></span>
                                                    {{ gestion_form.hora_proximo_seguimiento }}
                                                </div>
                                                {% if gestion_form.hora_proximo_seguimiento.errors %}<div class="invalid-feedback d-block">{{ gestion_form.hora_proximo_seguimiento.errors|join:", " }}</div>{% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Observaciones generales -->
                                    <div class="mb-3">
                                        <label for="{{ gestion_form.observaciones_generales.id_for_label }}" class="form-label d-flex align-items-center">
                                            <i class="bi bi-journal-text me-1 text-info"></i>
                                            <span>{{ gestion_form.observaciones_generales.label }}</span>
                                        </label>
                                        {{ gestion_form.observaciones_generales }}
                                        {% if gestion_form.observaciones_generales.errors %}<div class="invalid-feedback d-block">{{ gestion_form.observaciones_generales.errors|join:", " }}</div>{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botón de guardar -->
                    <div class="mt-4 text-end">
                        <button type="submit" class="btn btn-primary btn-lg px-4">
                            <i class="bi bi-save me-2"></i>Guardar Gestión
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Pestaña: Historial de Gestiones -->
        <div class="tab-pane fade" id="historial-gestiones" role="tabpanel" aria-labelledby="historial-gestiones-tab">
            <div class="card card-body shadow-sm border-top-0 rounded-bottom">
                <h5 class="card-title mb-3"><i class="bi bi-list-check me-2"></i>Historial de Gestiones</h5>
                {% if gestiones_cliente %}
                    <div class="table-responsive-xl" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-sm table-hover table-striped table-bordered" style="font-size: 0.85rem; min-width: 1200px; white-space: nowrap;">
                            <thead class="table-header-crea sticky-top">
                                <tr>
                                    <th class="text-center" style="width: 120px;">Fecha/Hora</th>
                                    <th class="text-center" style="width: 100px;">Usuario</th>
                                    <th class="text-center" style="width: 100px;">Canal</th>
                                    <th class="text-center" style="width: 120px;">Estado Contacto</th>
                                    <th class="text-center" style="width: 140px;">Tipo Gestión N1</th>
                                    <th class="text-center" style="width: 140px;">Tipo Gestión N2</th>
                                    <th class="text-center" style="width: 140px;">Tipo Gestión N3</th>
                                    <th class="text-center" style="width: 100px;">Acuerdo</th>
                                    <th class="text-center" style="width: 120px;">Fecha Acuerdo</th>
                                    <th class="text-center" style="width: 120px;">Monto</th>
                                    <th class="text-center" style="width: 120px;">Seguimiento</th>
                                    <th>Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for gestion in gestiones_cliente %}
                                <tr>
                                    <td class="text-center">{{ gestion.fecha_hora_gestion|date:"Y-m-d H:i" }}</td>
                                    <td class="text-center">{{ gestion.usuario_gestion.username|default:"N/A" }}</td>
                                    <td class="text-center">
                                        {% if gestion.canal_contacto == 'telefono' %}
                                            <span class="badge bg-warning" title="Teléfono"><i class="bi bi-telephone"></i></span>
                                        {% elif gestion.canal_contacto == 'whatsapp' %}
                                            <span class="badge bg-success" title="WhatsApp"><i class="bi bi-whatsapp"></i></span>
                                        {% elif gestion.canal_contacto == 'email' %}
                                            <span class="badge bg-primary" title="Email"><i class="bi bi-envelope"></i></span>
                                        {% elif gestion.canal_contacto == 'sms' %}
                                            <span class="badge bg-info" title="SMS"><i class="bi bi-chat"></i></span>
                                        {% else %}
                                            {{ gestion.get_canal_contacto_display|default:"N/A" }}
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if gestion.estado_contacto == 'contactado' %}
                                            <span class="badge bg-success">Contactado</span>
                                        {% elif gestion.estado_contacto == 'no_contactado' %}
                                            <span class="badge bg-warning">No Contactado</span>
                                        {% elif gestion.estado_contacto == 'numero_errado' %}
                                            <span class="badge bg-danger">Número Errado</span>
                                        {% else %}
                                            {{ gestion.get_estado_contacto_display|default:"N/A" }}
                                        {% endif %}
                                    </td>
                                    <td>{{ gestion.tipo_gestion_n1|default:"-" }}</td>
                                    <td>{{ gestion.tipo_gestion_n2|default:"-" }}</td>
                                    <td>{{ gestion.tipo_gestion_n3|default:"-" }}</td>
                                    <td class="text-center">
                                        {% if gestion.acuerdo_pago_realizado %}
                                            <span class="badge bg-success"><i class="bi bi-check-circle-fill"></i></span>
                                        {% else %}
                                            <span class="badge bg-secondary"><i class="bi bi-x-circle"></i></span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">{{ gestion.fecha_acuerdo|date:"Y-m-d"|default:"-" }}</td>
                                    <td class="text-end">{% if gestion.monto_acuerdo %}${{ gestion.monto_acuerdo|floatformat:0 }}{% else %}-{% endif %}</td>
                                    <td class="text-center">
                                        {% if gestion.seguimiento_requerido %}
                                            <span class="badge bg-info" title="Fecha: {{ gestion.fecha_proximo_seguimiento|date:'Y-m-d'|default:'No especificada' }}"><i class="bi bi-calendar-check"></i></span>
                                        {% else %}
                                            <span class="badge bg-secondary"><i class="bi bi-calendar-x"></i></span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div style="max-width: 300px; white-space: normal;">
                                            {% if gestion.observaciones_generales %}
                                                {{ gestion.observaciones_generales|linebreaksbr }}
                                            {% elif gestion.observaciones_acuerdo and gestion.acuerdo_pago_realizado %}
                                                <span class="text-muted">Acuerdo:</span> {{ gestion.observaciones_acuerdo|linebreaksbr }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mt-2">No hay gestiones registradas para este cliente.</p>
                {% endif %}
            </div>
        </div>

    </div> <!-- Fin Tab Content Principal -->
</div> <!-- Fin Div Principal del Bloque de Contenido -->
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Referencias a los campos de acuerdo de pago
    const acuerdoPagoCheckbox = document.getElementById('{{ gestion_form.acuerdo_pago_realizado.id_for_label }}');
    const fechaAcuerdoGroup = document.getElementById('{{ gestion_form.fecha_acuerdo.id_for_label }}').closest('.mb-3');
    const montoAcuerdoGroup = document.getElementById('{{ gestion_form.monto_acuerdo.id_for_label }}').closest('.mb-3');
    const observacionesAcuerdoGroup = document.getElementById('{{ gestion_form.observaciones_acuerdo.id_for_label }}').closest('.mb-3');
    
    // Referencias a los campos de seguimiento
    const seguimientoCheckbox = document.getElementById('{{ gestion_form.seguimiento_requerido.id_for_label }}');
    const camposSeguimientoDiv = document.getElementById('campos-seguimiento');
    
    // Referencias a campos interdependientes
    const canalContactoSelect = document.getElementById('{{ gestion_form.canal_contacto.id_for_label }}');
    const estadoContactoSelect = document.getElementById('{{ gestion_form.estado_contacto.id_for_label }}');
    const tipoGestionN1Select = document.getElementById('{{ gestion_form.tipo_gestion_n1.id_for_label }}');
    const tipoGestionN2Select = document.getElementById('{{ gestion_form.tipo_gestion_n2.id_for_label }}');
    const tipoGestionN3Select = document.getElementById('{{ gestion_form.tipo_gestion_n3.id_for_label }}');
    
    // Establecer teléfono como opción por defecto en canal de contacto
    if (canalContactoSelect) {
        if (!canalContactoSelect.value) {
            canalContactoSelect.value = 'telefono';
        }
    }
    
    // Función para mostrar/ocultar campos de acuerdo de pago
    function toggleAcuerdoPagoFields() {
        const isChecked = acuerdoPagoCheckbox.checked;
        fechaAcuerdoGroup.style.display = isChecked ? 'block' : 'none';
        montoAcuerdoGroup.style.display = isChecked ? 'block' : 'none';
        observacionesAcuerdoGroup.style.display = isChecked ? 'block' : 'none';
        
        // Si se desmarca, limpiar los campos
        if (!isChecked) {
            document.getElementById('{{ gestion_form.fecha_acuerdo.id_for_label }}').value = '';
            document.getElementById('{{ gestion_form.monto_acuerdo.id_for_label }}').value = '';
            document.getElementById('{{ gestion_form.observaciones_acuerdo.id_for_label }}').value = '';
        }
    }
    
    // Función para mostrar/ocultar campos de seguimiento
    function toggleSeguimientoFields() {
        const isChecked = seguimientoCheckbox.checked;
        camposSeguimientoDiv.style.display = isChecked ? 'block' : 'none';
        
        // Si se desmarca, limpiar los campos
        if (!isChecked) {
            document.getElementById('{{ gestion_form.fecha_proximo_seguimiento.id_for_label }}').value = '';
            document.getElementById('{{ gestion_form.hora_proximo_seguimiento.id_for_label }}').value = '';
        }
    }
    
    // Función para validar campos interdependientes
    function validateForm() {
        let isValid = true;
        let messages = [];
        
        // Validar que se haya seleccionado un estado de contacto
        if (!estadoContactoSelect.value) {
            isValid = false;
            messages.push('Debe seleccionar un estado de contacto');
            estadoContactoSelect.classList.add('is-invalid');
        } else {
            estadoContactoSelect.classList.remove('is-invalid');
        }
        
        // Si el estado es "contactado", validar que se haya seleccionado al menos el tipo de gestión nivel 1
        if (estadoContactoSelect.value === 'contactado' && !tipoGestionN1Select.value) {
            isValid = false;
            messages.push('Debe seleccionar al menos el tipo de gestión nivel 1 cuando el cliente fue contactado');
            tipoGestionN1Select.classList.add('is-invalid');
        } else {
            tipoGestionN1Select.classList.remove('is-invalid');
        }
        
        // Si se marcó acuerdo de pago, validar campos relacionados
        if (acuerdoPagoCheckbox.checked) {
            const fechaAcuerdoInput = document.getElementById('{{ gestion_form.fecha_acuerdo.id_for_label }}');
            const montoAcuerdoInput = document.getElementById('{{ gestion_form.monto_acuerdo.id_for_label }}');
            
            if (!fechaAcuerdoInput.value) {
                isValid = false;
                messages.push('Debe ingresar la fecha del acuerdo');
                fechaAcuerdoInput.classList.add('is-invalid');
            } else {
                fechaAcuerdoInput.classList.remove('is-invalid');
            }
            
            if (!montoAcuerdoInput.value || parseFloat(montoAcuerdoInput.value) <= 0) {
                isValid = false;
                messages.push('Debe ingresar un monto válido para el acuerdo');
                montoAcuerdoInput.classList.add('is-invalid');
            } else {
                montoAcuerdoInput.classList.remove('is-invalid');
            }
        }
        
        // Si se marcó seguimiento requerido, validar campos relacionados
        if (seguimientoCheckbox.checked) {
            const fechaSeguimientoInput = document.getElementById('{{ gestion_form.fecha_proximo_seguimiento.id_for_label }}');
            const horaSeguimientoInput = document.getElementById('{{ gestion_form.hora_proximo_seguimiento.id_for_label }}');
            
            if (!fechaSeguimientoInput.value) {
                isValid = false;
                messages.push('Debe ingresar la fecha del próximo seguimiento');
                fechaSeguimientoInput.classList.add('is-invalid');
            } else {
                fechaSeguimientoInput.classList.remove('is-invalid');
            }
            
            if (!horaSeguimientoInput.value) {
                isValid = false;
                messages.push('Debe ingresar la hora del próximo seguimiento');
                horaSeguimientoInput.classList.add('is-invalid');
            } else {
                horaSeguimientoInput.classList.remove('is-invalid');
            }
        }
        
        // Mostrar mensajes de error si los hay
        if (!isValid) {
            alert('Por favor corrija los siguientes errores:\n- ' + messages.join('\n- '));
        }
        
        return isValid;
    }
    
    // Inicializar estados al cargar la página
    toggleAcuerdoPagoFields();
    toggleSeguimientoFields();
    
    // Agregar event listeners
    acuerdoPagoCheckbox.addEventListener('change', toggleAcuerdoPagoFields);
    seguimientoCheckbox.addEventListener('change', toggleSeguimientoFields);
    
    // Agregar validación al formulario
    const form = document.querySelector('#registrar-gestion form');
    form.addEventListener('submit', function(event) {
        if (!validateForm()) {
            event.preventDefault();
        }
    });
    
    // Definición de opciones para tipo de gestión según estado de contacto
    const opcionesGestion = {
        'contactado': {
            // Opciones cuando el cliente fue contactado
            'informacion': { label: 'Información', subniveles: {
                'info_deuda': { label: 'Información de Deuda', subniveles: {} },
                'info_descuentos': { label: 'Información de Descuentos', subniveles: {} },
                'info_proceso_pago': { label: 'Información de Proceso de Pago', subniveles: {} }
            }},
            'acuerdo': { label: 'Acuerdo de Pago', subniveles: {
                'compromiso_pago': { label: 'Compromiso de Pago', subniveles: {} },
                'plan_pagos': { label: 'Plan de Pagos', subniveles: {} }
            }},
            'reclamacion': { label: 'Reclamación', subniveles: {
                'error_facturacion': { label: 'Error en Facturación', subniveles: {} },
                'calidad_servicio': { label: 'Calidad del Servicio', subniveles: {} }
            }},
            'otro': { label: 'Otro', subniveles: {} }
        },
        'no_contactado': {
            // Opciones cuando el cliente no fue contactado
            'no_contesta': { label: 'No Contesta', subniveles: {} },
            'buzon': { label: 'Buzón de Voz', subniveles: {} },
            'ocupado': { label: 'Línea Ocupada', subniveles: {} }
        },
        'numero_errado': {
            // Opciones cuando el número es errado
            'no_existe': { label: 'Número No Existe', subniveles: {} },
            'fuera_servicio': { label: 'Fuera de Servicio', subniveles: {} },
            'equivocado': { label: 'Número Equivocado', subniveles: {} }
        }
    };
    
    // Función para cargar opciones en los selectores de tipo de gestión
    function cargarOpcionesGestion() {
        const estadoSeleccionado = estadoContactoSelect.value;
        
        // Limpiar los selectores
        tipoGestionN1Select.innerHTML = '';
        tipoGestionN2Select.innerHTML = '<option value="">---------</option>';
        tipoGestionN3Select.innerHTML = '<option value="">---------</option>';
        
        // Verificar si existe el estado seleccionado en nuestras opciones
        if (estadoSeleccionado && opcionesGestion[estadoSeleccionado]) {
            // Cargar opciones de nivel 1 según el estado
            const opciones = opcionesGestion[estadoSeleccionado];
            
            // Agregar las opciones al selector de nivel 1
            for (const [valor, data] of Object.entries(opciones)) {
                const option = document.createElement('option');
                option.value = valor;
                option.textContent = data.label;
                tipoGestionN1Select.appendChild(option);
            }
        }
    }
    
    // Función para cargar opciones de nivel 2 basadas en la selección de nivel 1
    function cargarOpcionesGestionN2() {
        const estadoSeleccionado = estadoContactoSelect.value;
        const opcionN1 = tipoGestionN1Select.value;
        
        // Limpiar los selectores de nivel 2 y 3
        tipoGestionN2Select.innerHTML = '<option value="">---------</option>';
        tipoGestionN3Select.innerHTML = '<option value="">---------</option>';
        
        // Verificar si existen subniveles para la opción seleccionada
        if (estadoSeleccionado && opcionN1 && 
            opcionesGestion[estadoSeleccionado] && 
            opcionesGestion[estadoSeleccionado][opcionN1] && 
            opcionesGestion[estadoSeleccionado][opcionN1].subniveles) {
            
            const subniveles = opcionesGestion[estadoSeleccionado][opcionN1].subniveles;
            
            // Agregar las opciones al selector de nivel 2
            for (const [valor, data] of Object.entries(subniveles)) {
                const option = document.createElement('option');
                option.value = valor;
                option.textContent = data.label;
                tipoGestionN2Select.appendChild(option);
            }
        }
    }
    
    // Función para cargar opciones de nivel 3 basadas en la selección de nivel 2
    function cargarOpcionesGestionN3() {
        const estadoSeleccionado = estadoContactoSelect.value;
        const opcionN1 = tipoGestionN1Select.value;
        const opcionN2 = tipoGestionN2Select.value;
        
        // Limpiar el selector de nivel 3
        tipoGestionN3Select.innerHTML = '<option value="">---------</option>';
        
        // Verificar si existen subniveles para la opción seleccionada de nivel 2
        if (estadoSeleccionado && opcionN1 && opcionN2 && 
            opcionesGestion[estadoSeleccionado] && 
            opcionesGestion[estadoSeleccionado][opcionN1] && 
            opcionesGestion[estadoSeleccionado][opcionN1].subniveles && 
            opcionesGestion[estadoSeleccionado][opcionN1].subniveles[opcionN2] && 
            opcionesGestion[estadoSeleccionado][opcionN1].subniveles[opcionN2].subniveles) {
            
            const subniveles = opcionesGestion[estadoSeleccionado][opcionN1].subniveles[opcionN2].subniveles;
            
            // Agregar las opciones al selector de nivel 3
            for (const [valor, data] of Object.entries(subniveles)) {
                const option = document.createElement('option');
                option.value = valor;
                option.textContent = data.label;
                tipoGestionN3Select.appendChild(option);
            }
        }
    }
    
    // Función para actualizar el estado visual de los campos cuando cambia el estado de contacto
    estadoContactoSelect.addEventListener('change', function() {
        const isContactado = this.value === 'contactado';
        
        // Actualizar opciones de tipo de gestión según el estado seleccionado
        cargarOpcionesGestion();
        
        // Si no es contactado, deshabilitar acuerdo de pago
        if (!isContactado) {
            acuerdoPagoCheckbox.checked = false;
            toggleAcuerdoPagoFields();
        }
        
        // Habilitar/deshabilitar los selectores de tipo de gestión según corresponda
        tipoGestionN1Select.disabled = false; // Siempre habilitado, solo cambian las opciones
    });
    
    // Event listeners para los selectores de tipo de gestión
    tipoGestionN1Select.addEventListener('change', cargarOpcionesGestionN2);
    tipoGestionN2Select.addEventListener('change', cargarOpcionesGestionN3);
    
    // Disparar el evento para inicializar correctamente
    const event = new Event('change');
    estadoContactoSelect.dispatchEvent(event);
});
</script>
{% endblock %}