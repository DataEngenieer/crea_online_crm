{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}
{% block content %}
{% if gestion_form.non_field_errors %}
<div class="alert alert-danger mb-3 fw-bold">
    <ul class="mb-0">
        {% for error in gestion_form.non_field_errors %}
            <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}
<div class="px-0">
    <!-- Resumen Superior -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body d-flex flex-wrap align-items-center detalle-cliente-header-custom">
            <div class="flex-grow-1">
                <h3 class="mb-1">{{ cliente_representativo.nombre_completo|default:"Cliente sin nombre" }}</h3>
                <div class="mb-2 text-muted fs-6">
                    <i class="bi bi-credit-card"></i> {{ documento_cliente|default:"N/A" }} &nbsp;|&nbsp;
                    <i class="bi bi-geo-alt"></i> {{ cliente_representativo.ciudad|default:"N/A" }} &nbsp;|&nbsp;
                    <i class="bi bi-phone"></i> {{ cliente_representativo.telefono_celular|default:cliente_representativo.celular_1|default:"N/A" }} &nbsp;
                    <!--<span class="badge bg-{{ estado_cliente.color }} ms-2" title="{{ estado_cliente.descripcion }}">
                        <i class="bi {{ estado_cliente.icono }} me-1"></i>{{ estado_cliente.nombre }}
                    </span>-->
                </div>
            </div>
            <div class="mt-2 mt-md-0">
                <a href="https://wa.me/{{ cliente_representativo.telefono_celular|default:cliente_representativo.celular_1|default:'' }}" target="_blank" class="btn btn-success btn-sm me-1"><i class="bi bi-whatsapp"></i> WhatsApp</a>
                <a href="sms:{{ cliente_representativo.telefono_celular|default:cliente_representativo.celular_1|default:'' }}" class="btn btn-info btn-sm me-1 text-white"><i class="bi bi-chat-text-fill"></i> SMS</a>
                <a href="tel:{{ cliente_representativo.telefono_celular|default:cliente_representativo.celular_1|default:'' }}" class="btn btn-warning btn-sm me-1"><i class="bi bi-telephone"></i> Llamar</a>
                <a href="{% url 'core:enviar_email_prueba' documento_cliente=documento_cliente %}" class="btn btn-secondary btn-sm me-1"><i class="bi bi-envelope"></i> Enviar Correo</a>
                <a href="{% url 'core:clientes' %}" class="btn btn-light me-1"><i class="bi bi-arrow-left"></i> Volver a Clientes</a>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-0" id="clienteTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="registrar-gestion-tab" data-bs-toggle="tab" data-bs-target="#registrar-gestion" type="button" role="tab" aria-controls="registrar-gestion" aria-selected="true">Registrar Gestión</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="historial-gestiones-tab" data-bs-toggle="tab" data-bs-target="#historial-gestiones" type="button" role="tab" aria-controls="historial-gestiones" aria-selected="false">Historial de Gestiones</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="historial-acuerdos-tab" data-bs-toggle="tab" data-bs-target="#historial-acuerdos" type="button" role="tab" aria-controls="historial-acuerdos" aria-selected="false">Acuerdos de Pago</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="financiera-consolidada-tab" data-bs-toggle="tab" data-bs-target="#financiera-consolidada" type="button" role="tab" aria-controls="financiera-consolidada" aria-selected="false">Información Financiera</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="info-contacto-tab" data-bs-toggle="tab" data-bs-target="#info-contacto" type="button" role="tab" aria-controls="info-contacto" aria-selected="false">Información Detallada y Contactos</button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="clienteTabContent">
        <!-- Cargar contenido de pestañas externas -->
        <div class="tab-pane fade show active" id="registrar-gestion" role="tabpanel" aria-labelledby="registrar-gestion-tab">
            {% include "core/partials/tab_registrar_gestion.html" %}
        </div>
        <div class="tab-pane fade" id="historial-gestiones" role="tabpanel" aria-labelledby="historial-gestiones-tab">
            {% include "core/partials/tab_historial_gestiones.html" %}
        </div>
        <div class="tab-pane fade" id="historial-acuerdos" role="tabpanel" aria-labelledby="historial-acuerdos-tab">
            {% include "core/partials/tab_historial_acuerdos.html" %}
        </div>
        <div class="tab-pane fade" id="financiera-consolidada" role="tabpanel" aria-labelledby="financiera-consolidada-tab">
            {% include "core/partials/tab_informacion_financiera.html" %}
        </div>
        <div class="tab-pane fade" id="info-contacto" role="tabpanel" aria-labelledby="info-contacto-tab">
            {% include "core/partials/tab_info_contacto.html" %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Tu bloque JS completo queda igual aquí -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Código para depurar el envío del formulario
    const formularioGestion = document.getElementById('gestion-form');
    const botonGuardar = document.getElementById('btn-guardar-gestion');
    
    // Verificar si los elementos existen
    if (formularioGestion) {
        console.log('Formulario de gestión encontrado, configurando listeners');
        
        // Detectar clic en el botón de guardar
        if (botonGuardar) {
            console.log('Botón de guardar encontrado, añadiendo listener de clic');
            botonGuardar.addEventListener('click', function(event) {
                console.log('=== CLIC EN BOTÓN GUARDAR DETECTADO ===');
                console.log('Tipo de evento:', event.type);
                console.log('Target:', event.target);
                console.log('Propiedades del botón:', {
                    id: this.id,
                    name: this.name,
                    type: this.type,
                    disabled: this.disabled,
                    className: this.className
                });
                
                // Verificar si hay cuotas para enviar como AJAX
                const acuerdoSection = document.getElementById('acuerdo_pago_section_container');
                const cuotasJsonValue = document.getElementById('cuotas-json')?.value;
                
                if (acuerdoSection && acuerdoSection.style.display !== 'none' && cuotasJsonValue && cuotasJsonValue !== '[]') {
                    // Marcar el formulario para procesamiento AJAX
                    formularioGestion.setAttribute('data-ajax-submit', 'true');
                }
                
                // No prevenimos el evento para que continue y se ejecute el submit
                // Solo estamos registrando que se hizo clic
            });
        } else {
            console.error('CRÍTICO: Botón de guardar NO encontrado');
        }

        // Depurar envío del formulario
        formularioGestion.addEventListener('submit', function(event) {
            // Prevenir temporalmente el envío para poder ver los datos
            event.preventDefault();
            
            console.log('=== DEPURACIÓN: EVENTO SUBMIT DEL FORMULARIO ===');
            console.log('Tipo de evento:', event.type);
            console.log('¿Event.defaultPrevented?', event.defaultPrevented);
            console.log('Form action:', this.action || 'No tiene action específico');
            console.log('Form method:', this.method || 'No tiene method específico');
            console.log('Form enctype:', this.enctype);
            
            const formData = new FormData(this);
            
            // Verificar campos clave
            console.log('\n=== CAMPOS CLAVE DEL FORMULARIO ===');
            console.log('¿Existe campo cliente?', formData.has('cliente'), formData.get('cliente'));
            console.log('¿Existe campo guardar_gestion?', formData.has('guardar_gestion'), formData.get('guardar_gestion'));
            console.log('¿Existe canal_contacto?', formData.has('canal_contacto'), formData.get('canal_contacto'));
            console.log('¿Existe estado_contacto?', formData.has('estado_contacto'), formData.get('estado_contacto'));
            console.log('¿Existe tipo_gestion_n1?', formData.has('tipo_gestion_n1'), formData.get('tipo_gestion_n1'));
            console.log('¿Existe csrfmiddlewaretoken?', formData.has('csrfmiddlewaretoken'));
            
            // Mostrar campos y valores
            console.log('\n=== TODOS LOS CAMPOS DEL FORMULARIO ===');
            const formDataObj = {};
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
                formDataObj[key] = value;
            }
            
            // Validar campos requeridos manualmente
            let camposVacios = [];
            let camposConError = formularioGestion.querySelectorAll('.invalid-feedback');
            if (camposConError.length > 0) {
                console.log('\n=== ERRORES DE VALIDACIÓN HTML ===');
                camposConError.forEach(campoError => {
                    console.log('Error encontrado:', campoError.textContent.trim());
                });
            }
            
            // Verificar si es un acuerdo de pago con cuotas para enviar como AJAX
            const acuerdoSection = document.getElementById('acuerdo_pago_section_container');
            const cuotasJsonValue = document.getElementById('cuotas-json')?.value;
            
            if (acuerdoSection && acuerdoSection.style.display !== 'none' && 
                cuotasJsonValue && cuotasJsonValue !== '[]' && 
                this.getAttribute('data-ajax-submit') === 'true') {
                
                console.log('\n=== ENVIANDO FORMULARIO VIA AJAX PARA CAPTURAR ID DE ACUERDO ===');
                
                // Agregar encabezado para indicar que es una solicitud AJAX
                const headers = {
                    'X-Requested-With': 'XMLHttpRequest'
                };
                
                // Enviar formulario mediante fetch
                fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: headers
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Respuesta del servidor:', data);
                    
                    // Actualizar el campo acuerdo_id con el ID recibido
                    if (data.acuerdo_id) {
                        document.getElementById('acuerdo_id').value = data.acuerdo_id;
                        console.log('Acuerdo ID actualizado:', data.acuerdo_id);
                        
                        // Mostrar el botón de múltiples pagos
                        const multiplePagosContainer = document.getElementById('multiple-pagos-container');
                        if (multiplePagosContainer) {
                            multiplePagosContainer.style.display = 'block';
                        }
                    }
                    
                    // Mostrar mensaje de éxito
                    if (data.mensaje) {
                        // Crear elemento de alerta
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success alert-dismissible fade show';
                        alertDiv.role = 'alert';
                        alertDiv.innerHTML = `
                            ${data.mensaje}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        `;
                        
                        // Insertar alerta al principio del contenido
                        const container = document.querySelector('.container-fluid');
                        if (container) {
                            container.insertBefore(alertDiv, container.firstChild);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error al guardar el acuerdo:', error);
                    alert('Error al guardar el acuerdo. Por favor, inténtelo de nuevo.');
                });
            } else {
                // Continuar con el envío normal
                console.log('\n=== ENVIANDO FORMULARIO EN 1 SEGUNDO ===');
                setTimeout(() => {
                    console.log('Enviando formulario al servidor...');
                    this.submit();
                }, 1000);
            }
        });
    } else {
        console.error('No se encontró el formulario de gestión en la página');
    }
    
    // Ocultar los contenedores de acuerdo de pago y seguimiento al cargar la página
    const camposAcuerdo = document.getElementById('campos-acuerdo');
    const camposSeguimiento = document.getElementById('campos-seguimiento');
    
    if (camposAcuerdo) camposAcuerdo.style.display = 'none';
    if (camposSeguimiento) camposSeguimiento.style.display = 'none';
    
    // Función para mostrar/ocultar opciones en selectores dependientes
    function actualizarOpcionesVisibles(selectorPadre, selectorHijo) {
        const valorSeleccionado = selectorPadre.value;
        // Ocultar todas las opciones excepto la primera
        Array.from(selectorHijo.options).forEach((option, index) => {
            if (index === 0) return;
            option.style.display = 'none';
        });
        // Mostrar solo las opciones correspondientes al valor seleccionado
        let opcionesVisibles = 0;
        Array.from(selectorHijo.options).forEach(option => {
            if (option.getAttribute('data-parent') === valorSeleccionado) {
                option.style.display = '';
                opcionesVisibles++;
            }
        });
        // Resetear el valor del selector hijo
        selectorHijo.value = '';
        // Habilitar si hay opciones, deshabilitar si no
        selectorHijo.disabled = (opcionesVisibles === 0);
    }
    // Al cargar la página, asegúrate de habilitar los selects si hay opciones
    // Referencias a los campos de formulario (MOVIDAS ARRIBA)
    const estadoContactoSelect = document.getElementById('{{ gestion_form.estado_contacto.id_for_label }}');
    const tipoGestionN1Select = document.getElementById('{{ gestion_form.tipo_gestion_n1.id_for_label }}');
    const canalContactoSelect = document.getElementById('{{ gestion_form.canal_contacto.id_for_label }}');
    
    // Al cargar la página, y después de declarar las constantes:
    if (!tipoGestionN1Select) {
        console.error("CRITICAL-INIT: El elemento select 'tipoGestionN1Select' (ID: {{ gestion_form.tipo_gestion_n1.id_for_label }}) NO fue encontrado en el DOM al inicializar.");
    } else {
        console.log("INIT: Elemento 'tipoGestionN1Select' (ID: {{ gestion_form.tipo_gestion_n1.id_for_label }}) encontrado correctamente.");
        // Habilitar el select si hay opciones y fue encontrado
        if (tipoGestionN1Select.options.length > 1) {
            tipoGestionN1Select.disabled = false;
        }
    }
    
    // Referencias a los contenedores de sección principales
    const acuerdoPagoSectionContainer = document.getElementById('acuerdo_pago_section_container');
    const seguimientoSectionContainer = document.getElementById('seguimiento_section_container');
    const comprobantePagoContainer = document.getElementById('comprobante_pago_container');
    const fechaPagoEfectivoContainer = document.getElementById('fecha_pago_efectivo_container');
    const urlTiposGestion = "{% url 'core:ajax_get_opciones_nivel2' %}";

    console.log('Elementos del DOM inicializados:', {
        canalContactoSelect,
        estadoContactoSelect,
        tipoGestionN1Select,
        acuerdoPagoSectionContainer,
        seguimientoSectionContainer,
        comprobantePagoContainer,
        fechaPagoEfectivoContainer
    });

    if (!estadoContactoSelect) console.error('ERROR: estadoContactoSelect no encontrado');
    if (!tipoGestionN1Select) console.error('ERROR: tipoGestionN1Select no encontrado');
    
    // Referencias a los campos de acuerdo de pago (el checkbox fue eliminado)
    const fechaAcuerdoGroup = document.getElementById('{{ gestion_form.fecha_acuerdo.id_for_label }}').closest('.mb-3');
    const montoAcuerdoGroup = document.getElementById('{{ gestion_form.monto_acuerdo.id_for_label }}').closest('.mb-3');
    const observacionesAcuerdoGroup = document.getElementById('{{ gestion_form.observaciones_acuerdo.id_for_label }}').closest('.mb-3');
    
    // Referencias a los campos de seguimiento (el checkbox fue eliminado)
    const camposSeguimientoDiv = document.getElementById('campos-seguimiento');
    
    // Establecer teléfono como opción por defecto en canal de contacto
    if (canalContactoSelect) {
        if (!canalContactoSelect.value) {
            canalContactoSelect.value = 'whatsapp';
        }
    }
    
    // Evento para cambio en estado de contacto
    if (estadoContactoSelect) {
        console.log('estadoContactoSelect encontrado. Añadiendo event listener.');
        estadoContactoSelect.addEventListener('change', function() {
            console.log('Estado contacto cambiado. ID:', this.value);
            const estadoContactoId = this.value;
            console.log('Estado de contacto seleccionado:', estadoContactoId);
            
            if (!tipoGestionN1Select) {
                console.error('CRITICAL: tipoGestionN1Select NO encontrado al inicio del evento change de estadoContactoSelect.');
                // return; // Podríamos detener la ejecución aquí si es crítico
            } else {
                console.log('tipoGestionN1Select SÍ encontrado al inicio del evento change.');
            }
            // Limpiar y deshabilitar tipoGestionN1Select antes de la carga.');
            
            // Limpiar y deshabilitar el selector de tipo de gestión
            if (tipoGestionN1Select) {
                tipoGestionN1Select.innerHTML = '';
                tipoGestionN1Select.disabled = true;
                console.log('tipoGestionN1Select limpiado y deshabilitado.');
            } else {
                console.error('ERROR: tipoGestionN1Select no encontrado al intentar limpiar/deshabilitar.');
                return; // Salir si el select no existe
            }
            
            if (estadoContactoId) {
                console.log(`Realizando fetch a: ${urlTiposGestion}?estado_contacto_id=${estadoContactoId}`);
                fetch(`${urlTiposGestion}?estado_contacto_id=${estadoContactoId}`)
                    .then(response => {
                        console.log('Respuesta de fetch recibida:', response);
                        if (!response.ok) {
                            console.error('Error en la respuesta de fetch:', response.status, response.statusText);
                            return response.text().then(text => { throw new Error('Respuesta de servidor no OK: ' + text); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Datos JSON recibidos para Tipo de Gestión:', data);
                        if (tipoGestionN1Select) {
                            updateSelectWithOptions(tipoGestionN1Select, data, 'Seleccione Tipo de Gestión');
                            tipoGestionN1Select.disabled = false;
                            console.log('Opciones de tipo de gestión cargadas y tipoGestionN1Select habilitado.');
                        } else {
                            console.error('ERROR: tipoGestionN1Select no encontrado al intentar actualizar opciones.');
                        }
                    })
                    .catch(error => {
                        console.error('Error en la petición AJAX para tipos de gestión o al procesar JSON:', error);
                        if (tipoGestionN1Select) {
                            tipoGestionN1Select.innerHTML = '<option value="">Error al cargar</option>'; // Mostrar error en el select
                            tipoGestionN1Select.disabled = false; // Habilitar para que el usuario vea el error
                        }
                    });
            } // Cierre del if (estadoContactoId)
        }); // Cierre del addEventListener
    } else {
        console.error('ERROR: estadoContactoSelect no encontrado, no se pudo añadir event listener.');
    }
    
    // Función para actualizar las opciones de un select (RESTAURADA)
    function updateSelectWithOptions(selectElement, options, defaultOptionText) {
        console.log('updateSelectWithOptions llamada con:', selectElement, options, defaultOptionText);
        if (!selectElement) {
            console.error('CRITICAL: selectElement es nulo en updateSelectWithOptions');
            return;
        }
        if (!Array.isArray(options)) {
            console.error('Error: las opciones no son un array.', options);
            // Mostrar un mensaje de error en el select
            selectElement.innerHTML = '<option value="">Error: Formato de opciones incorrecto</option>';
            return;
        }
        selectElement.innerHTML = ''; // Limpiar opciones existentes
        
        // Añadir opción por defecto
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = defaultOptionText;
        selectElement.appendChild(defaultOption);

        // Añadir nuevas opciones
        options.forEach(function(option) {
            const opt = document.createElement('option');
            opt.value = option.value;
            opt.textContent = option.label;
            selectElement.appendChild(opt);
        });
    }
    
    // Evento para cambio en tipo de gestión
    tipoGestionN1Select.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const tipoGestionValue = this.value;
        console.log(`tipoGestionN1Select CHANGED. Value: '${tipoGestionValue}', Text: '${selectedOption ? selectedOption.text : 'N/A'}'`);
        toggleFieldsBasedOnSelection(tipoGestionValue);
        
        // Asegurar que el campo permanezca habilitado después de seleccionar un valor
        setTimeout(() => {
            this.disabled = false;
            console.log('tipoGestionN1Select habilitado nuevamente después de cambio');
        }, 100);
    });
    
    // Si hay valores preseleccionados, disparar el evento change para cargar las opciones
    if (estadoContactoSelect && estadoContactoSelect.value) {
        console.log('Estado de contacto tiene valor preseleccionado:', estadoContactoSelect.value, '. Disparando evento change.');
        estadoContactoSelect.dispatchEvent(new Event('change'));
        // Si también hay un valor en tipo de gestión, aplicar la lógica condicional
        if (tipoGestionN1Select && tipoGestionN1Select.value) {
            console.log('Tipo de gestión tiene valor preseleccionado:', tipoGestionN1Select.value, '. Aplicando lógica condicional.');
            toggleFieldsBasedOnSelection(tipoGestionN1Select.value);
            // Asegurar que el campo permanezca habilitado
            tipoGestionN1Select.disabled = false;
        }
    }
    
    // --- INICIO FUNCIONES DE GESTIÓN DE SECCIONES ---
    function manageAcuerdoPagoSection(show) {
        const section = document.getElementById('acuerdo_pago_section_container');
        const fieldsContainer = document.getElementById('campos-acuerdo');
        const fechaAcuerdoInput = document.getElementById('{{ gestion_form.fecha_acuerdo.id_for_label }}');
        const montoAcuerdoInput = document.getElementById('{{ gestion_form.monto_acuerdo.id_for_label }}');
        const observacionesAcuerdoInput = document.getElementById('{{ gestion_form.observaciones_acuerdo.id_for_label }}');

        if (section) section.style.display = show ? 'block' : 'none';
        if (fieldsContainer) fieldsContainer.style.display = show ? 'block' : 'none';

        const inputsToManage = [fechaAcuerdoInput, montoAcuerdoInput, observacionesAcuerdoInput];
        inputsToManage.forEach(input => {
            if (input) input.disabled = !show;
        });

        if (!show) {
            inputsToManage.forEach(input => {
                if (input) input.value = '';
            });
        }
    }

    function manageSeguimientoSection(show) {
        console.log(`manageSeguimientoSection llamada con show: ${show}`);
        const section = document.getElementById('seguimiento_section_container');
        const fieldsContainer = document.getElementById('campos-seguimiento');
        if (!section) console.error('manageSeguimientoSection: No se encontró seguimiento_section_container');
        if (!fieldsContainer) console.error('manageSeguimientoSection: No se encontró campos-seguimiento');
        const fechaSeguimientoInput = document.getElementById('{{ gestion_form.fecha_proximo_seguimiento.id_for_label }}');
        const horaSeguimientoInput = document.getElementById('{{ gestion_form.hora_proximo_seguimiento.id_for_label }}');
        // Eliminamos observacionesGeneralesInput de esta función ya que debe estar siempre habilitado

        if (section) section.style.display = show ? 'block' : 'none';
        if (fieldsContainer) fieldsContainer.style.display = show ? 'block' : 'none';

        // Solo manejamos los campos específicos de seguimiento
        const inputsToManage = [fechaSeguimientoInput, horaSeguimientoInput];
        inputsToManage.forEach(input => {
            if (input) input.disabled = !show;
        });

        if (!show) {
            inputsToManage.forEach(input => {
                if (input) input.value = '';
            });
        }
    }

    function manageComprobantePagoSection(show) {
        const section = document.getElementById('comprobante_pago_container'); // Este es el ID del col-md-4
        // fechaPagoEfectivoContainer está dentro de comprobante_pago_container, por lo que se mostrará/ocultará con su padre.
        const comprobantePagoInput = document.getElementById('{{ gestion_form.comprobante_pago.id_for_label }}');
        const fechaPagoEfectivoInput = document.getElementById('{{ gestion_form.fecha_pago_efectivo.id_for_label }}');

        if (section) section.style.display = show ? 'block' : 'none';

        const inputsToManage = [comprobantePagoInput, fechaPagoEfectivoInput];
        inputsToManage.forEach(input => {
            if (input) input.disabled = !show;
        });

        if (!show) {
            inputsToManage.forEach(input => {
                if (input) {
                    if (input.type === 'file') {
                        input.value = null; // Para campos de archivo
                    } else {
                        input.value = '';
                    }
                }
            });
        }
    }
    // --- FIN FUNCIONES DE GESTIÓN DE SECCIONES ---
    
    // Función para validar campos interdependientes
    function validateForm() {
        let isValid = true;
        let messages = [];
        
        // Validar que se haya seleccionado un estado de contacto
        if (!estadoContactoSelect || !estadoContactoSelect.value) {
            isValid = false;
            messages.push('Debe seleccionar un estado de contacto.');
            if (estadoContactoSelect) estadoContactoSelect.classList.add('is-invalid');
        } else {
            if (estadoContactoSelect) estadoContactoSelect.classList.remove('is-invalid');
        }

        // Validar que se haya seleccionado un tipo de gestión N1
        if (!tipoGestionN1Select || !tipoGestionN1Select.value) {
            isValid = false;
            messages.push('Debe seleccionar un tipo de gestión.');
            if (tipoGestionN1Select) tipoGestionN1Select.classList.add('is-invalid');
        } else {
            if (tipoGestionN1Select) tipoGestionN1Select.classList.remove('is-invalid');
        }

        // Validar campos de Acuerdo de Pago si la sección está visible
        const acuerdoSection = document.getElementById('acuerdo_pago_section_container');
        if (acuerdoSection && acuerdoSection.style.display !== 'none') {
            const fechaAcuerdoInput = document.getElementById('{{ gestion_form.fecha_acuerdo.id_for_label }}');
            const montoAcuerdoInput = document.getElementById('{{ gestion_form.monto_acuerdo.id_for_label }}');
            const montoAcuerdoValidacion = document.getElementById('monto-acuerdo-validacion');
            
            if (!fechaAcuerdoInput.value) {
                isValid = false; messages.push('Acuerdo: Debe ingresar la fecha del acuerdo.'); fechaAcuerdoInput.classList.add('is-invalid');
            } else { fechaAcuerdoInput.classList.remove('is-invalid'); }
            
            if (!montoAcuerdoInput.value || parseFloat(montoAcuerdoInput.value) <= 0) {
                isValid = false; messages.push('Acuerdo: Debe ingresar un monto válido.'); montoAcuerdoInput.classList.add('is-invalid');
            } else { 
                montoAcuerdoInput.classList.remove('is-invalid'); 
                
                // Validar que la suma de las cuotas coincida con el monto del acuerdo (si hay cuotas)
                if (cuotas.length > 0) {
                    const montoTotal = parseFloat(montoAcuerdoInput.value);
                    const sumaCuotas = cuotas.reduce((sum, cuota) => sum + parseFloat(cuota.monto || 0), 0);
                    
                    if (Math.abs(montoTotal - sumaCuotas) > 0.01) { // Permitir una pequeña diferencia por redondeo
                        isValid = false;
                        messages.push('El monto total de las cuotas debe coincidir con el monto del acuerdo.');
                        if (montoAcuerdoValidacion) {
                            montoAcuerdoValidacion.style.display = 'block';
                            montoAcuerdoValidacion.textContent = `El monto del acuerdo ($${montoTotal.toFixed(2)}) debe coincidir con la suma de las cuotas ($${sumaCuotas.toFixed(2)})`;
                        }
                    } else if (montoAcuerdoValidacion) {
                        montoAcuerdoValidacion.style.display = 'none';
                    }
                }
            }
        }

        // Validar campos de Seguimiento si la sección está visible
        const seguimientoSection = document.getElementById('seguimiento_section_container');
        if (seguimientoSection && seguimientoSection.style.display !== 'none') {
            const fechaSeguimientoInput = document.getElementById('{{ gestion_form.fecha_proximo_seguimiento.id_for_label }}');
            const horaSeguimientoInput = document.getElementById('{{ gestion_form.hora_proximo_seguimiento.id_for_label }}');
            if (!fechaSeguimientoInput.value) {
                isValid = false; messages.push('Seguimiento: Debe ingresar la fecha.'); fechaSeguimientoInput.classList.add('is-invalid');
            } else { fechaSeguimientoInput.classList.remove('is-invalid'); }
            if (!horaSeguimientoInput.value) {
                isValid = false; messages.push('Seguimiento: Debe ingresar la hora.'); horaSeguimientoInput.classList.add('is-invalid');
            } else { horaSeguimientoInput.classList.remove('is-invalid'); }
        }

        // Validar campos de Comprobante de Pago si la sección está visible
        const comprobanteSection = document.getElementById('comprobante_pago_container');
        if (comprobanteSection && comprobanteSection.style.display !== 'none') {
            const comprobantePagoInput = document.getElementById('{{ gestion_form.comprobante_pago.id_for_label }}');
            const fechaPagoEfectivoInput = document.getElementById('{{ gestion_form.fecha_pago_efectivo.id_for_label }}');
            // La validación del archivo es opcional aquí, podría ser más compleja (ej. verificar si se subió)
            // if (!comprobantePagoInput.value) {
            //     isValid = false; messages.push('Comprobante: Debe adjuntar un comprobante.'); comprobantePagoInput.classList.add('is-invalid');
            // } else { comprobantePagoInput.classList.remove('is-invalid'); }
            if (!fechaPagoEfectivoInput.value) {
                isValid = false; messages.push('Comprobante: Debe ingresar la fecha de pago efectivo.'); fechaPagoEfectivoInput.classList.add('is-invalid');
            } else { fechaPagoEfectivoInput.classList.remove('is-invalid'); }
        }

        if (!isValid) {
            alert('Por favor corrija los siguientes errores:\n- ' + messages.join('\n- '));
        }
        return isValid;
    }
    
    // Agregar validación al formulario
    const form = document.querySelector('#registrar-gestion form');
    form.addEventListener('submit', function(event) {
        if (!validateForm()) {
            event.preventDefault();
        }
    });
    
    // Configuración de los desplegables dependientes usando AJAX
    // La constante urlTiposGestion ya ha sido declarada y movida al inicio del DOMContentLoaded.
    // El addEventListener para estadoContactoSelect y la lógica de dispatchEvent ya están definidos anteriormente (around lines 800-900+)
    // por lo que este bloque if (estadoContactoSelect) { ... } que estaba aquí y contenía erróneamente
    // la declaración de fechaPagoEfectivoContainer y la definición de toggleFieldsBasedOnSelection
    // ya no es necesario en esta posición con ese contenido.
    // Si se necesita un if(estadoContactoSelect) para alguna lógica específica aquí, se debe añadir explícitamente.

    // Función para mostrar u ocultar secciones según la selección de tipo de gestión
    function toggleFieldsBasedOnSelection(tipoGestionValue) {
        console.log('toggleFieldsBasedOnSelection llamado con:', tipoGestionValue);
        // Ocultar todas las secciones primero
        manageAcuerdoPagoSection(false);
        manageSeguimientoSection(false);
        manageComprobantePagoSection(false);
        
        // Asegurar que el campo de observaciones generales siempre esté habilitado
        const observacionesGeneralesInput = document.getElementById('{{ gestion_form.observaciones_generales.id_for_label }}');
        if (observacionesGeneralesInput) {
            observacionesGeneralesInput.disabled = false;
            console.log('Campo de observaciones generales habilitado');
        }
        
        // Controlar la visibilidad del campo de observaciones
        const observacionesContainer = document.getElementById('observaciones-container');
        if (observacionesContainer) {
            observacionesContainer.style.display = 'block'; // Por defecto mostrar el campo de observaciones
        }
        
        // Crear un campo oculto para seguimiento_requerido si no existe
        let seguimientoRequeridoInput = document.getElementById('id_seguimiento_requerido');
        if (!seguimientoRequeridoInput) {
            seguimientoRequeridoInput = document.createElement('input');
            seguimientoRequeridoInput.type = 'hidden';
            seguimientoRequeridoInput.id = 'id_seguimiento_requerido';
            seguimientoRequeridoInput.name = 'seguimiento_requerido';
            document.getElementById('formulario_gestion').appendChild(seguimientoRequeridoInput);
        }
        
        // Por defecto, el seguimiento no es requerido
        seguimientoRequeridoInput.value = 'False';

        if (!tipoGestionValue) return; // Si no hay valor, todas permanecen ocultas

        // Convertir a minúsculas para comparación insensible a mayúsculas/minúsculas
        const tipoGestionLower = tipoGestionValue.toLowerCase();

        // Verificar si el tipo de gestión es 'solicita_llamada' independientemente de mayúsculas/minúsculas
        const esSolicitaLlamada = tipoGestionLower === 'solicita_llamada' || 
                               tipoGestionValue === 'SOLICITA_LLAMADA' ||
                               tipoGestionValue.includes('solicita') && tipoGestionValue.includes('llamada');

        if (esSolicitaLlamada) {
            console.log("toggleFieldsBasedOnSelection: Detectado tipo 'solicita_llamada'");
            manageSeguimientoSection(true);
            // Marcar automáticamente el seguimiento como requerido
            seguimientoRequeridoInput.value = 'True';
            console.log("Seguimiento requerido marcado automáticamente como True");
            // Ocultar el campo de observaciones cuando se muestra el módulo de seguimiento
            if (observacionesContainer) {
                observacionesContainer.style.display = 'none';
            }
            return;
        }

        // Continuar con el resto de casos
        switch (tipoGestionValue) {
            case 'PAGADO':
            case 'pagado':
                manageComprobantePagoSection(true);
                break;
            case 'AP': // Acuerdo Pendiente
            case 'ap':
            case 'PP': // Promesa de Pago
            case 'pp':
                manageAcuerdoPagoSection(true);
                // Ocultar el campo de observaciones cuando se muestra el módulo de acuerdos de pago
                if (observacionesContainer) {
                    observacionesContainer.style.display = 'none';
                }
                break;
            case 'NC': // Negociación en Curso
            case 'nc':
                console.log("toggleFieldsBasedOnSelection: Entrando en caso 'NC' (Negociación en Curso)");
                // Ya no activamos el módulo de seguimiento para NC
                break;
            // Para el resto de tipificaciones, el campo de observaciones permanece visible por defecto
        }
    }
    
    // ===== INICIO: CÓDIGO PARA MÚLTIPLES FECHAS Y MONTOS DE PAGO =====
    // Referencias a elementos del DOM para múltiples pagos
    const btnAgregarCuota = document.getElementById('btn-agregar-cuota');
    const cuotasContainer = document.getElementById('cuotas-container');
    const cuotasJson = document.getElementById('cuotas-json');
    const totalCuotas = document.getElementById('total-cuotas');
    const totalMontos = document.getElementById('total-montos');
    const btnMultiplePagos = document.getElementById('btn-multiple-pagos');
    const multiplePagosContainer = document.getElementById('multiple-pagos-container');
    
    // Array para almacenar las cuotas
    let cuotas = [];
    
    // Función para actualizar el contador y el total de montos
    function actualizarResumen() {
        if (!totalCuotas || !totalMontos) return;
        
        totalCuotas.textContent = cuotas.length;
        
        const total = cuotas.reduce((sum, cuota) => sum + parseFloat(cuota.monto || 0), 0);
        totalMontos.textContent = total.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        
        // Actualizar el campo oculto con los datos de las cuotas en formato JSON
        if (cuotasJson) {
            cuotasJson.value = JSON.stringify(cuotas);
        }
        
        // Mostrar u ocultar el botón de múltiples pagos según si hay cuotas
        if (multiplePagosContainer) {
            const acuerdoId = document.getElementById('acuerdo_id')?.value;
            // Solo mostrar si hay cuotas Y hay un ID de acuerdo
            multiplePagosContainer.style.display = (cuotas.length > 0 && acuerdoId) ? 'block' : 'none';
        }
        
        // Validar si el monto total de las cuotas coincide con el monto del acuerdo
        const montoAcuerdoInput = document.getElementById('{{ gestion_form.monto_acuerdo.id_for_label }}');
        const montoAcuerdoValidacion = document.getElementById('monto-acuerdo-validacion');
        
        if (montoAcuerdoInput && montoAcuerdoInput.value && cuotas.length > 0) {
            const montoTotal = parseFloat(montoAcuerdoInput.value);
            
            if (Math.abs(montoTotal - total) > 0.01) { // Permitir una pequeña diferencia por redondeo
                if (montoAcuerdoValidacion) {
                    montoAcuerdoValidacion.style.display = 'block';
                    montoAcuerdoValidacion.textContent = `El monto del acuerdo ($${montoTotal.toFixed(2)}) debe coincidir con la suma de las cuotas ($${total.toFixed(2)})`;
                }
            } else if (montoAcuerdoValidacion) {
                montoAcuerdoValidacion.style.display = 'none';
            }
        }
    }
    
    // Función para agregar una nueva cuota
    function agregarCuota() {
        if (!cuotasContainer) return;
        
        const id = Date.now(); // ID único basado en timestamp
        
        // Obtener la fecha actual en formato YYYY-MM-DD para usar como valor mínimo
        const hoy = new Date();
        const fechaActual = hoy.toISOString().split('T')[0];
        
        const nuevaCuota = {
            id: id,
            fecha: '', // No establecer fecha por defecto
            monto: ''
        };
        
        cuotas.push(nuevaCuota);
        
        // Crear fila para la nueva cuota
        const tr = document.createElement('tr');
        tr.id = `cuota-${id}`;
        tr.innerHTML = `
            <td>
                <input type="date" class="form-control form-control-sm fecha-cuota is-invalid" 
                       data-id="${id}" value="" min="${fechaActual}" required 
                       oninvalid="this.setCustomValidity('La fecha de la cuota es obligatoria')" 
                       oninput="this.setCustomValidity('')">
                <div class="invalid-feedback">
                    Debe seleccionar una fecha para esta cuota
                </div>
            </td>
            <td>
                <div class="input-group input-group-sm">
                    <span class="input-group-text">$</span>
                    <input type="number" step="0.01" class="form-control form-control-sm monto-cuota" 
                           data-id="${id}" required>
                </div>
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger eliminar-cuota" 
                        data-id="${id}">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        cuotasContainer.appendChild(tr);
        
        // Agregar event listeners a los nuevos campos
        const fechaInput = tr.querySelector('.fecha-cuota');
        const montoInput = tr.querySelector('.monto-cuota');
        const btnEliminar = tr.querySelector('.eliminar-cuota');
        
        // Forzar la validación visual desde el inicio
        fechaInput.focus();
        fechaInput.blur();
        
        fechaInput.addEventListener('change', function() {
            const id = this.getAttribute('data-id');
            const cuota = cuotas.find(c => c.id == id);
            if (cuota) {
                // Validar que la fecha sea válida
                if (this.value && this.value.trim() !== '') {
                    cuota.fecha = this.value;
                    // Quitar cualquier clase de error
                    this.classList.remove('is-invalid');
                } else {
                    // Mantener la clase de error si está vacío
                    this.classList.add('is-invalid');
                    alert('La fecha de la cuota no puede estar vacía. Por favor seleccione una fecha.');
                }
                actualizarResumen();
            }
        });
        
        // También validar cuando el campo pierde el foco
        fechaInput.addEventListener('blur', function() {
            if (!this.value || this.value.trim() === '') {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
        
        // Evitar que se pueda borrar la fecha
        fechaInput.addEventListener('keydown', function(e) {
            if (e.key === 'Delete' || e.key === 'Backspace') {
                e.preventDefault();
                alert('No se puede borrar la fecha de la cuota. Si desea cambiarla, seleccione otra fecha.');
            }
        });
        
        montoInput.addEventListener('change', function() {
            const id = this.getAttribute('data-id');
            const cuota = cuotas.find(c => c.id == id);
            if (cuota) {
                cuota.monto = this.value;
                actualizarResumen();
            }
        });
        
        btnEliminar.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            eliminarCuota(id);
        });
        
        actualizarResumen();
    }
    
    // Función para eliminar una cuota
    function eliminarCuota(id) {
        const index = cuotas.findIndex(c => c.id == id);
        if (index !== -1) {
            cuotas.splice(index, 1);
            const fila = document.getElementById(`cuota-${id}`);
            if (fila) fila.remove();
            actualizarResumen();
        }
    }
    
    // Event listener para el botón de agregar cuota
    if (btnAgregarCuota) {
        btnAgregarCuota.addEventListener('click', agregarCuota);
    }
    
    // Forzar la validación de fechas en todas las cuotas existentes
    function validarTodasLasFechas() {
        const fechaInputs = document.querySelectorAll('.fecha-cuota');
        const fechaActual = new Date().toISOString().split('T')[0];
        let seCorrigieron = false;
        
        fechaInputs.forEach(input => {
            const id = input.getAttribute('data-id');
            const cuota = cuotas.find(c => c.id == id);
            
            if (!input.value || input.value.trim() === '') {
                input.value = fechaActual;
                if (cuota) cuota.fecha = fechaActual;
                input.classList.add('is-invalid');
                setTimeout(() => input.classList.remove('is-invalid'), 2000);
                seCorrigieron = true;
            }
        });
        
        if (seCorrigieron) {
            alert('Se han corregido fechas vacías con la fecha actual');
            actualizarResumen();
        }
        
        return !seCorrigieron;
    }
    
    // Validar el formulario completo antes de enviarlo
    document.getElementById('formulario_gestion').addEventListener('submit', function(e) {
        // Verificar si hay cuotas y si todas tienen fecha válida
        if (cuotas.length > 0) {
            const fechasInvalidas = cuotas.filter(c => !c.fecha || c.fecha.trim() === '');
            if (fechasInvalidas.length > 0) {
                e.preventDefault(); // Detener el envío del formulario
                alert('No se puede guardar el acuerdo. Hay cuotas sin fecha seleccionada.');
                
                // Marcar visualmente los campos inválidos
                document.querySelectorAll('.fecha-cuota').forEach(input => {
                    const id = input.getAttribute('data-id');
                    const cuota = cuotas.find(c => c.id == id);
                    if (cuota && (!cuota.fecha || cuota.fecha.trim() === '')) {
                        input.classList.add('is-invalid');
                    }
                });
                
                return false;
            }
        }
    });
    
    // Event listener para el botón de registrar múltiples pagos
    if (btnMultiplePagos) {
        btnMultiplePagos.addEventListener('click', function() {
            // Forzar validación de fechas
            validarTodasLasFechas();
            // Verificar que haya al menos una cuota
            if (cuotas.length === 0) {
                alert('Debe agregar al menos una cuota al acuerdo de pago');
                return;
            }
            
            // Validar que todas las cuotas tengan fecha válida y monto
            const cuotasIncompletas = cuotas.filter(c => !c.fecha || c.fecha.trim() === '' || !c.monto);
            if (cuotasIncompletas.length > 0) {
                alert('Todas las cuotas deben tener fecha y monto válidos');
                return;
            }
            
            // Verificar formato de fecha válido (YYYY-MM-DD)
            const fechaInvalida = cuotas.some(c => !/^\d{4}-\d{2}-\d{2}$/.test(c.fecha));
            if (fechaInvalida) {
                alert('Algunas fechas tienen formato inválido. Asegúrate de seleccionar fechas del calendario');
                return;
            }
            
            // Corregir automáticamente cualquier fecha inválida
            const fechaActual = new Date().toISOString().split('T')[0];
            let seCorrigieronFechas = false;
            
            cuotas.forEach(cuota => {
                if (!cuota.fecha || !/^\d{4}-\d{2}-\d{2}$/.test(cuota.fecha)) {
                    cuota.fecha = fechaActual;
                    seCorrigieronFechas = true;
                    
                    // También actualizar el input en el DOM
                    const fechaInput = document.querySelector(`.fecha-cuota[data-id="${cuota.id}"]`);
                    if (fechaInput) fechaInput.value = fechaActual;
                }
            });
            
            if (seCorrigieronFechas) {
                alert('Se han corregido automáticamente algunas fechas inválidas');
                actualizarResumen();
            }
            
            // Obtener el ID del acuerdo desde el formulario (si existe)
            const acuerdoId = document.querySelector('input[name="acuerdo_id"]')?.value;
            if (!acuerdoId) {
                alert('No se ha seleccionado un acuerdo de pago');
                return;
            }
            
            // Abrir la página de registro de múltiples pagos
            window.location.href = `{% url 'core:registrar_multiple_pagos' acuerdo_id=0 %}`.replace('0', acuerdoId);
        });
    }
    // ===== FIN: CÓDIGO PARA MÚLTIPLES FECHAS Y MONTOS DE PAGO =====
});
</script>
{% endblock %}