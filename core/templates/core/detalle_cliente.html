{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}

{% block content %}

{% if gestion_form.non_field_errors %}
    <div class="alert alert-danger mb-3 fw-bold">
        <ul class="mb-0">
            {% for error in gestion_form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<div class="px-0">
    <!-- Resumen Superior -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body d-flex flex-wrap align-items-center detalle-cliente-header-custom">
            <div class="flex-grow-1">
                <h3 class="mb-1">{{ cliente_representativo.nombre_completo|default:"Cliente sin nombre" }}</h3>
                <div class="mb-2 text-muted fs-6">
                    <i class="bi bi-credit-card"></i> {{ documento_cliente|default:"N/A" }} &nbsp;|&nbsp;
                    <i class="bi bi-geo-alt"></i> {{ cliente_representativo.ciudad|default:"N/A" }} &nbsp;|&nbsp;
                    <i class="bi bi-phone"></i> {{ cliente_representativo.celular_1|default:"N/A" }} &nbsp;
                    
                    {% comment %}Lógica para determinar el estado de negociación{% endcomment %}
                    {% with ultimo_acuerdo=gestiones_cliente|dictsortreversed:'fecha_hora_gestion'|first %}
                        {% if ultimo_acuerdo and ultimo_acuerdo.acuerdo_pago_realizado %}
                            {% if ultimo_acuerdo.fecha_acuerdo and ultimo_acuerdo.fecha_acuerdo < today %}
                                <span class="badge bg-warning ms-2" title="Acuerdo de pago vencido"><i class="bi bi-exclamation-triangle me-1"></i>Acuerdo Vencido</span>
                            {% else %}
                                <span class="badge bg-success ms-2" title="Acuerdo de pago vigente"><i class="bi bi-check-circle me-1"></i>Con Acuerdo</span>
                            {% endif %}
                        {% elif gestiones_cliente %}
                            <span class="badge bg-info ms-2" title="En proceso de negociación"><i class="bi bi-arrow-repeat me-1"></i>En Negociación</span>
                        {% elif cliente_representativo.estado == 'Activo' %}
                            <span class="badge bg-primary ms-2" title="Cliente activo, sin gestión"><i class="bi bi-person-check me-1"></i>Sin Gestión</span>
                        {% else %}
                            <span class="badge bg-{% if cliente_representativo.estado == 'Activo' %}success{% elif cliente_representativo.estado == 'Inactivo' %}danger{% else %}secondary{% endif %} ms-2">{{ cliente_representativo.estado|default:"N/A" }}</span>
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
            <div class="mt-2 mt-md-0">
                <a href="https://wa.me/{{ cliente_representativo.celular_1|default:'' }}" target="_blank" class="btn btn-success btn-sm me-1"><i class="bi bi-whatsapp"></i> WhatsApp</a>
                <a href="sms:{{ cliente_representativo.celular_1|default:'' }}" class="btn btn-info btn-sm me-1 text-white"><i class="bi bi-chat-text-fill"></i> SMS</a>
                <a href="tel:{{ cliente_representativo.celular_1|default:'' }}" class="btn btn-warning btn-sm me-1"><i class="bi bi-telephone"></i> Llamar</a>
                <a href="{% url 'core:enviar_email_prueba' documento_cliente=documento_cliente %}" class="btn btn-secondary btn-sm me-1"><i class="bi bi-envelope"></i> Enviar Correo</a>
                <a href="{% url 'core:clientes' %}" class="btn btn-light me-1"><i class="bi bi-arrow-left"></i> Volver a Clientes</a>
            </div>
        </div>
    </div>

    <!-- Tabs para secciones -->
    <ul class="nav nav-tabs mb-0" id="clienteTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="registrar-gestion-tab" data-bs-toggle="tab" data-bs-target="#registrar-gestion" type="button" role="tab" aria-controls="registrar-gestion" aria-selected="true">Registrar Gestión</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="historial-gestiones-tab" data-bs-toggle="tab" data-bs-target="#historial-gestiones" type="button" role="tab" aria-controls="historial-gestiones" aria-selected="false">Historial de Gestiones</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="financiera-consolidada-tab" data-bs-toggle="tab" data-bs-target="#financiera-consolidada" type="button" role="tab" aria-controls="financiera-consolidada" aria-selected="false">Información Financiera</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="info-contacto-tab" data-bs-toggle="tab" data-bs-target="#info-contacto" type="button" role="tab" aria-controls="info-contacto" aria-selected="false">Información Detallada y Contactos</button>
        </li>
    </ul>

    <div class="tab-content" id="clienteTabContent">
        <!-- Pestaña: Información Financiera Consolidada (Unificada con Lista de Productos) -->
        <div class="tab-pane fade" id="financiera-consolidada" role="tabpanel" aria-labelledby="financiera-consolidada-tab">
            <div class="card card-body shadow-sm border-top-0 rounded-bottom p-3">
                <!-- Encabezado del panel financiero -->
                <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-currency-dollar me-2 text-success"></i>Información Financiera y Productos
                    </h5>
                    <span class="badge bg-primary">Documento: {{ documento_cliente }} | Total: {{ referencias_cliente|length }} productos</span>
                </div>
                
                <!-- Resumen financiero en tarjetas -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100 bg-light">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="rounded-circle bg-success p-2 me-2">
                                        <i class="bi bi-cash text-white"></i>
                                    </div>
                                    <h6 class="mb-0">Principal Total</h6>
                                </div>
                                <div class="display-6 text-success fw-bold">${{ saldo_capital_total|intcomma|default:'0' }}</div>
                                <div class="small text-muted mt-2">
                                    <i class="bi bi-info-circle"></i> Capital inicial pendiente
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100 bg-light">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="rounded-circle bg-warning p-2 me-2">
                                        <i class="bi bi-bank text-white"></i>
                                    </div>
                                    <h6 class="mb-0">Valor Pagado</h6>
                                </div>
                                <div class="display-6 text-warning fw-bold">${{ valor_pagado_total|intcomma|default:'0' }}</div>
                                <div class="small text-muted mt-2">
                                    <i class="bi bi-credit-card"></i> Total abonado a la deuda
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100 bg-light">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="rounded-circle bg-primary p-2 me-2">
                                        <i class="bi bi-calculator text-white"></i>
                                    </div>
                                    <h6 class="mb-0">Deuda Total Consolidada</h6>
                                </div>
                                <div class="display-6 text-primary fw-bold">${{ deuda_total_consolidada|intcomma|default:'0' }}</div>
                                <div class="small text-muted mt-2">
                                    <i class="bi bi-graph-up-arrow"></i> Incluye capital + intereses + otros cargos
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Pestañas internas: Tabla y Detalle -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light">
                        <ul class="nav nav-tabs card-header-tabs" id="productos-tab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="tabla-productos-tab" data-bs-toggle="tab" data-bs-target="#tabla-productos" type="button" role="tab" aria-controls="tabla-productos" aria-selected="true">
                                    <i class="bi bi-table me-1"></i>Tabla de Productos
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="detalle-productos-tab" data-bs-toggle="tab" data-bs-target="#detalle-productos" type="button" role="tab" aria-controls="detalle-productos" aria-selected="false">
                                    <i class="bi bi-card-list me-1"></i>Detalle por Producto
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body p-0">
                        <div class="tab-content" id="productos-tabContent">
                            <!-- Tabla de Productos -->
                            <div class="tab-pane fade show active p-3" id="tabla-productos" role="tabpanel" aria-labelledby="tabla-productos-tab">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover table-striped table-bordered" style="font-size: 0.85rem;">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Ref.</th>
                                                <th>Nombre Completo</th>
                                                <th>F. Cesión</th>
                                                <th>F. Registro</th>
                                                <th>F. Act.</th>
                                                <th>Estado</th>
                                                <th class="text-end">Principal</th>
                                                <th class="text-end">Deuda Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for ref in referencias_cliente %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-info">
                                                        <i class="bi bi-tag-fill me-1"></i>{{ ref.referencia|default:'N/A' }}
                                                    </span>
                                                </td>
                                                <td>{{ ref.nombre_completo|truncatechars:30|default:'N/A' }}</td>
                                                <td>{{ ref.fecha_cesion|date:'d M Y'|default:'N/A' }}</td>
                                                <td>{{ ref.fecha_registro|date:'d M Y'|default:'N/A' }}</td>
                                                <td>{{ ref.fecha_act|date:'d M Y'|default:'N/A' }}</td>
                                                <td class="text-center">
                                                    <span class="badge bg-{% if ref.estado == 'Activo' %}success{% elif ref.estado == 'Inactivo' %}danger{% else %}secondary{% endif %}">
                                                        <i class="bi bi-circle-fill me-1"></i>{{ ref.estado|default:'N/A' }}
                                                    </span>
                                                </td>
                                                <td class="text-end fw-bold">${{ ref.principal|intcomma|default:'0' }}</td>
                                                <td class="text-end fw-bold">${{ ref.deuda_total|intcomma|default:'0' }}</td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="8" class="text-center text-muted py-3">
                                                    <i class="bi bi-exclamation-circle me-2"></i>No hay referencias para este cliente.
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Detalle por Producto -->
                            <div class="tab-pane fade p-3" id="detalle-productos" role="tabpanel" aria-labelledby="detalle-productos-tab">
                                <div class="accordion accordion-flush" id="accordionProductos">
                                    {% if referencias_cliente %}
                                        {% for ref in referencias_cliente %}
                                        <div class="accordion-item border mb-2 rounded">
                                            <h2 class="accordion-header" id="heading-producto-{{ ref.id }}">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-producto-{{ ref.id }}" aria-expanded="false" aria-controls="collapse-producto-{{ ref.id }}">
                                                    <i class="bi bi-tag-fill me-2 text-primary"></i>
                                                    <strong>{{ ref.referencia|default:'N/A' }}</strong>
                                                    <span class="ms-2 badge bg-{% if ref.estado == 'Activo' %}success{% elif ref.estado == 'Inactivo' %}danger{% else %}secondary{% endif %}">
                                                        {{ ref.estado|default:'N/A' }}
                                                    </span>
                                                    <span class="ms-auto me-3 text-primary fw-bold">${{ ref.deuda_total|intcomma|default:'0' }}</span>
                                                </button>
                                            </h2>
                                            <div id="collapse-producto-{{ ref.id }}" class="accordion-collapse collapse" aria-labelledby="heading-producto-{{ ref.id }}">
                                                <div class="accordion-body">
                                                    <div class="row g-3">
                                                        <div class="col-md-6">
                                                            <div class="card h-100 border-0 shadow-sm">
                                                                <div class="card-header bg-light d-flex align-items-center">
                                                                    <i class="bi bi-cash-coin me-2 text-success"></i>
                                                                    <h6 class="mb-0">Información Financiera</h6>
                                                                </div>
                                                                <div class="card-body p-3">
                                                                    <div class="row g-2">
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">Principal:</span>
                                                                                <span class="fw-bold">${{ ref.principal|intcomma|default:'0' }}</span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">Deuda Total:</span>
                                                                                <span class="fw-bold text-primary">${{ ref.deuda_total|intcomma|default:'0' }}</span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">Días Mora:</span>
                                                                                <span class="fw-bold text-danger">{{ ref.dias_mora_caso_sas|default:'0' }}</span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">Estado:</span>
                                                                                <span class="badge bg-{% if ref.estado == 'Activo' %}success{% elif ref.estado == 'Inactivo' %}danger{% else %}secondary{% endif %}">
                                                                                    {{ ref.estado|default:'N/A' }}
                                                                                </span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="card h-100 border-0 shadow-sm">
                                                                <div class="card-header bg-light d-flex align-items-center">
                                                                    <i class="bi bi-calendar-date me-2 text-info"></i>
                                                                    <h6 class="mb-0">Fechas y Datos Adicionales</h6>
                                                                </div>
                                                                <div class="card-body p-3">
                                                                    <div class="row g-2">
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">F. Cesión:</span>
                                                                                <span>{{ ref.fecha_cesion|date:'d M Y'|default:'N/A' }}</span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">F. Registro:</span>
                                                                                <span>{{ ref.fecha_registro|date:'d M Y'|default:'N/A' }}</span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">F. Act.:</span>
                                                                                <span>{{ ref.fecha_act|date:'d M Y'|default:'N/A' }}</span>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-6 mb-2">
                                                                            <div class="d-flex align-items-center">
                                                                                <span class="text-muted me-2" style="width: 100px; font-size: 0.85rem;">Cliente:</span>
                                                                                <span>{{ ref.nombre_completo|truncatechars:25|default:'N/A' }}</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="alert alert-info" role="alert">
                                            <i class="bi bi-info-circle-fill me-2"></i>No hay referencias disponibles para mostrar detalles.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pestaña: Información General (del cliente_representativo) y Contactos -->
        <div class="tab-pane fade" id="info-contacto" role="tabpanel" aria-labelledby="info-contacto-tab">
            <div class="card card-body shadow-sm border-top-0 rounded-bottom p-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title mb-0"><i class="bi bi-info-circle me-1"></i>Información Detallada y Contactos</h5>
                </div>

                <!-- Datos Generales - Formato compacto -->
                <div class="mb-2 p-2 border rounded bg-light">
                    <div class="d-flex align-items-center mb-1">
                        <i class="bi bi-person-badge me-1"></i>
                        <h6 class="mb-0 fs-6">Datos Generales</h6>
                    </div>
                    <div class="row g-1">
                        <div class="col-md-4 mb-1">
                            <div class="d-flex align-items-center">
                                <span class="text-muted me-1" style="width: 110px; font-size: 0.85rem;">Tipo Documento:</span>
                                <span class="badge bg-secondary">{{ cliente_representativo.tipo_documento|default:'N/A' }}</span>
                            </div>
                        </div>
                        <div class="col-md-4 mb-1">
                            <div class="d-flex align-items-center">
                                <span class="text-muted me-1" style="width: 110px; font-size: 0.85rem;">Nombre:</span>
                                <span>{{ cliente_representativo.nombre_completo|default:'N/A' }}</span>
                            </div>
                        </div>
                        <div class="col-md-4 mb-1">
                            <div class="d-flex align-items-center">
                                <span class="text-muted me-1" style="width: 110px; font-size: 0.85rem;">Ciudad:</span>
                                <span>{{ cliente_representativo.ciudad|default:'N/A' }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información de productos -->
                <div class="accordion accordion-flush" id="accordionContactosProductos">
                    {% if referencias_cliente %}
                        {% for ref in referencias_cliente %}
                        <div class="accordion-item border mb-1 rounded">
                            <h2 class="accordion-header" id="heading-{{ ref.id }}">
                                <button class="accordion-button collapsed p-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ ref.id }}" aria-expanded="false" aria-controls="collapse-{{ ref.id }}">
                                    <i class="bi bi-tag-fill me-1 text-primary"></i>
                                    <strong>{{ ref.referencia|default:'N/A' }}</strong>
                                    <span class="ms-2 text-muted small">{{ ref.nombre_completo|truncatechars:30|default:'Cliente' }}</span>
                                </button>
                            </h2>
                            <div id="collapse-{{ ref.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ ref.id }}">
                                <div class="accordion-body p-2">
                                    <div class="row g-0">
                                        <!-- Contactos -->
                                        <div class="col-md-6 p-1">
                                            <div class="border-start border-primary ps-2 mb-1" style="border-left-width: 3px !important;">
                                                <span class="fw-bold text-primary"><i class="bi bi-telephone-fill me-1"></i>Contactos</span>
                                            </div>
                                            <div class="row g-0">
                                                <div class="col-lg-6 p-1">
                                                    <div class="d-flex align-items-center">
                                                        <span class="text-muted me-1" style="width: 70px; font-size: 0.8rem;">Celular 1:</span>
                                                        <a href="tel:{{ ref.celular_1 }}" class="ms-1 badge bg-warning text-dark">{{ ref.celular_1|default:'N/A' }}</a>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 p-1">
                                                    <div class="d-flex align-items-center">
                                                        <span class="text-muted me-1" style="width: 70px; font-size: 0.8rem;">Celular 2:</span>
                                                        <span>{{ ref.celular_2|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 p-1">
                                                    <div class="d-flex align-items-center">
                                                        <span class="text-muted me-1" style="width: 70px; font-size: 0.8rem;">Celular 3:</span>
                                                        <span>{{ ref.celular_3|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 p-1">
                                                    <div class="d-flex align-items-center">
                                                        <span class="text-muted me-1" style="width: 70px; font-size: 0.8rem;">Teléfono:</span>
                                                        <span>{{ ref.telefono_1|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 p-1">
                                                    <div class="d-flex align-items-center">
                                                        <span class="text-muted me-1" style="width: 70px; font-size: 0.8rem;">Teléfono 2:</span>
                                                        <span>{{ ref.telefono_2|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-lg-6 p-1">
                                                    <div class="d-flex align-items-center">
                                                        <span class="text-muted me-1" style="width: 70px; font-size: 0.8rem;">Email:</span>
                                                        <span>{{ ref.email|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Direcciones -->
                                        <div class="col-md-6 p-1">
                                            <div class="border-start border-success ps-2 mb-1" style="border-left-width: 3px !important;">
                                                <span class="fw-bold text-success"><i class="bi bi-geo-alt-fill me-1"></i>Direcciones</span>
                                            </div>
                                            <div class="row g-0">
                                                <div class="col-12 p-1">
                                                    <div class="d-flex">
                                                        <span class="text-muted me-1" style="min-width: 30px; font-size: 0.8rem;">1:</span>
                                                        <span style="font-size: 0.85rem;">{{ ref.direccion_1|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-12 p-1">
                                                    <div class="d-flex">
                                                        <span class="text-muted me-1" style="min-width: 30px; font-size: 0.8rem;">2:</span>
                                                        <span style="font-size: 0.85rem;">{{ ref.direccion_2|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-12 p-1">
                                                    <div class="d-flex">
                                                        <span class="text-muted me-1" style="min-width: 30px; font-size: 0.8rem;">3:</span>
                                                        <span style="font-size: 0.85rem;">{{ ref.direccion_3|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-12 p-1">
                                                    <div class="d-flex">
                                                        <span class="text-muted me-1" style="min-width: 30px; font-size: 0.8rem;">4:</span>
                                                        <span style="font-size: 0.85rem;">{{ ref.direccion_4|default:'N/A' }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted mt-2">No hay referencias para este cliente.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Pestaña: Registrar Gestión -->
        <div class="tab-pane fade show active" id="registrar-gestion" role="tabpanel" aria-labelledby="registrar-gestion-tab">
            <div class="card card-body shadow-sm border-top-0 rounded-bottom p-3">
                <!-- Encabezado del formulario -->
                <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-headset me-2 text-primary"></i>Registrar Nueva Gestión
                    </h5>
                    <span class="badge bg-primary">Cliente: {{ cliente_representativo.nombre_completo }}</span>
                </div>
                
                <form method="post" class="needs-validation" id="formulario_gestion" novalidate>
                    {% csrf_token %}
                    {{ gestion_form.cliente }} {# Campo oculto #}
                    <input type="hidden" name="guardar_gestion" value="1">
                    
                    <!-- Secciones del formulario con tarjetas -->
                    <div class="row g-3">
                        <!-- Sección 1: Información del Contacto -->
                        <div class="col-md-4">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-light d-flex align-items-center">
                                    <i class="bi bi-telephone-fill me-2 text-primary"></i>
                                    <h6 class="mb-0">Información del Contacto</h6>
                                </div>
                                <div class="card-body p-3">
                                    <!-- Canal de contacto con iconos -->
                                    <div class="mb-3">
                                        <label for="{{ gestion_form.canal_contacto.id_for_label }}" class="form-label d-flex align-items-center">
                                            <i class="bi bi-broadcast me-1 text-primary"></i>
                                            <span>{{ gestion_form.canal_contacto.label }}</span>
                                        </label>
                                        {{ gestion_form.canal_contacto }}
                                        {% if gestion_form.canal_contacto.errors %}<div class="invalid-feedback d-block text-danger fw-bold">{{ gestion_form.canal_contacto.errors|join:", " }}</div>{% endif %}
                                    </div>
                                    
                                    <!-- Estado de contacto -->
                                    <div class="mb-3">
                                        <label for="{{ gestion_form.estado_contacto.id_for_label }}" class="form-label d-flex align-items-center">
                                            <i class="bi bi-reception-4 me-1 text-primary"></i>
                                            <span>{{ gestion_form.estado_contacto.label }}</span>
                                        </label>
                                        {{ gestion_form.estado_contacto }}
                                        {% if gestion_form.estado_contacto.errors %}<div class="invalid-feedback d-block text-danger fw-bold">{{ gestion_form.estado_contacto.errors|join:", " }}</div>{% endif %}
                                    </div>
                                    
                                    <!-- Tipo de gestión -->
                                    <div class="mb-3">
                                        <label for="{{ gestion_form.tipo_gestion_n1.id_for_label }}" class="form-label d-flex align-items-center">
                                            <i class="bi bi-grid-1x2 me-1 text-primary"></i>
                                            <span>Tipo de Gestión</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-list"></i></span>
                                            {{ gestion_form.tipo_gestion_n1 }}
                                        </div>
                                        {% if gestion_form.tipo_gestion_n1.errors %}<div class="invalid-feedback d-block text-danger fw-bold">{{ gestion_form.tipo_gestion_n1.errors|join:", " }}</div>{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección 2: Acuerdo de Pago -->
                        <div class="col-md-4" id="acuerdo_pago_section_container" style="display: none;">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-light d-flex align-items-center">
                                    <i class="bi bi-cash-coin me-2 text-success"></i>
                                    <h6 class="mb-0">Acuerdo de Pago</h6>
                                </div>
                                <div class="card-body p-3">
                                    <!-- Campos de acuerdo -->
                                    <div id="campos-acuerdo" style="display: none;">
                                        <!-- Fecha de acuerdo -->
                                        <div class="mb-3">
                                            <label for="{{ gestion_form.fecha_acuerdo.id_for_label }}" class="form-label d-flex align-items-center">
                                                <i class="bi bi-calendar-date me-1 text-success"></i>
                                                <span>{{ gestion_form.fecha_acuerdo.label }}</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                                {{ gestion_form.fecha_acuerdo }}
                                            </div>
                                            {% if gestion_form.fecha_acuerdo.errors %}<div class="invalid-feedback d-block text-danger fw-bold">{{ gestion_form.fecha_acuerdo.errors|join:", " }}</div>{% endif %}
                                        </div>
                                        
                                        <!-- Monto de acuerdo -->
                                        <div class="mb-3">
                                            <label for="{{ gestion_form.monto_acuerdo.id_for_label }}" class="form-label d-flex align-items-center">
                                                <i class="bi bi-currency-dollar me-1 text-success"></i>
                                                <span>{{ gestion_form.monto_acuerdo.label }}</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                {{ gestion_form.monto_acuerdo }}
                                            </div>
                                            {% if gestion_form.monto_acuerdo.errors %}<div class="invalid-feedback d-block text-danger fw-bold">{{ gestion_form.monto_acuerdo.errors|join:", " }}</div>{% endif %}
                                        </div>
                                        
                                        <!-- Observaciones de acuerdo -->
                                        <div class="mb-3">
                                            <label for="{{ gestion_form.observaciones_acuerdo.id_for_label }}" class="form-label d-flex align-items-center">
                                                <i class="bi bi-chat-left-text me-1 text-success"></i>
                                                <span>{{ gestion_form.observaciones_acuerdo.label }}</span>
                                            </label>
                                            {{ gestion_form.observaciones_acuerdo }}
                                            {% if gestion_form.observaciones_acuerdo.errors %}<div class="invalid-feedback d-block text-danger fw-bold">{{ gestion_form.observaciones_acuerdo.errors|join:", " }}</div>{% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sección 3: Comprobante de Pago (visible solo cuando tipo_gestion_n2 = PAGADO) -->
                        <div class="col-md-4" id="comprobante_pago_container" style="display: none;">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-light d-flex align-items-center">
                                    <i class="bi bi-receipt me-2 text-success"></i>
                                    <h6 class="mb-0">Comprobante de Pago</h6>
                                </div>
                                <div class="card-body p-3">
                                    <!-- Campo comprobante de pago -->
                                    <div class="mb-3">
                                        <label for="{{ gestion_form.comprobante_pago.id_for_label }}" class="form-label d-flex align-items-center">
                                            <i class="bi bi-file-earmark-arrow-up me-1 text-success"></i>
                                            <span>{{ gestion_form.comprobante_pago.label }}</span>
                                        </label>
                                        {{ gestion_form.comprobante_pago }}
                                        {% if gestion_form.comprobante_pago.errors %}<div class="invalid-feedback d-block text-danger fw-bold">{{ gestion_form.comprobante_pago.errors|join:", " }}</div>{% endif %}
                                    </div>
                                    
                                    <!-- Fecha de pago efectivo -->
                                    <div class="mb-3" id="fecha_pago_efectivo_container">
                                        <label for="{{ gestion_form.fecha_pago_efectivo.id_for_label }}" class="form-label d-flex align-items-center">
                                            <i class="bi bi-calendar-check me-1 text-success"></i>
                                            <span>{{ gestion_form.fecha_pago_efectivo.label }}</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                            {{ gestion_form.fecha_pago_efectivo }}
                                        </div>
                                        {% if gestion_form.fecha_pago_efectivo.errors %}<div class="invalid-feedback d-block text-danger fw-bold">{{ gestion_form.fecha_pago_efectivo.errors|join:", " }}</div>{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sección 4: Seguimiento y Observaciones -->
                        <div class="col-md-4" id="seguimiento_section_container" style="display: none;">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-light d-flex align-items-center">
                                    <i class="bi bi-clipboard-check me-2 text-info"></i>
                                    <h6 class="mb-0">Seguimiento y Observaciones</h6>
                                </div>
                                <div class="card-body p-3">
                                    <!-- Campos de seguimiento -->
                                    <div id="campos-seguimiento" style="display: none;">
                                        <div class="row">
                                            <!-- Fecha de próximo seguimiento -->
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ gestion_form.fecha_proximo_seguimiento.id_for_label }}" class="form-label d-flex align-items-center">
                                                    <i class="bi bi-calendar-week me-1 text-info"></i>
                                                    <span>{{ gestion_form.fecha_proximo_seguimiento.label }}</span>
                                                </label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                                                    {{ gestion_form.fecha_proximo_seguimiento }}
                                                </div>
                                                {% if gestion_form.fecha_proximo_seguimiento.errors %}<div class="invalid-feedback d-block text-danger fw-bold">{{ gestion_form.fecha_proximo_seguimiento.errors|join:", " }}</div>{% endif %}
                                            </div>
                                            
                                            <!-- Hora de próximo seguimiento -->
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ gestion_form.hora_proximo_seguimiento.id_for_label }}" class="form-label d-flex align-items-center">
                                                    <i class="bi bi-clock me-1 text-info"></i>
                                                    <span>{{ gestion_form.hora_proximo_seguimiento.label }}</span>
                                                </label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="bi bi-clock"></i></span>
                                                    {{ gestion_form.hora_proximo_seguimiento }}
                                                </div>
                                                {% if gestion_form.hora_proximo_seguimiento.errors %}<div class="invalid-feedback d-block text-danger fw-bold">{{ gestion_form.hora_proximo_seguimiento.errors|join:", " }}</div>{% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Observaciones generales -->
                                    <div class="mb-3">
                                        <label for="{{ gestion_form.observaciones_generales.id_for_label }}" class="form-label d-flex align-items-center">
                                            <i class="bi bi-journal-text me-1 text-info"></i>
                                            <span>{{ gestion_form.observaciones_generales.label }}</span>
                                        </label>
                                        {{ gestion_form.observaciones_generales }}
                                        {% if gestion_form.observaciones_generales.errors %}<div class="invalid-feedback d-block text-danger fw-bold">{{ gestion_form.observaciones_generales.errors|join:", " }}</div>{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botón de guardar -->
                    <div class="mt-4 text-end">
                        <button type="submit" name="guardar_gestion" id="btn_guardar_gestion" value="1" class="btn btn-primary btn-lg px-4">
                            <i class="bi bi-save me-2"></i>Guardar Gestión
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Pestaña: Historial de Gestiones -->
        <div class="tab-pane fade" id="historial-gestiones" role="tabpanel" aria-labelledby="historial-gestiones-tab">
            <div class="card card-body shadow-sm border-top-0 rounded-bottom">
                <h5 class="card-title mb-3"><i class="bi bi-list-check me-2"></i>Historial de Gestiones</h5>
                {% if gestiones_cliente %}
                    <div class="table-responsive-xl" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-sm table-hover table-striped table-bordered" style="font-size: 0.85rem; min-width: 1200px; white-space: nowrap;">
                            <thead class="table-header-crea sticky-top">
                                <tr>
                                    <th class="text-center" style="width: 120px;">Fecha/Hora</th>
                                    <th class="text-center" style="width: 100px;">Usuario</th>
                                    <th class="text-center" style="width: 100px;">Canal</th>
                                    <th class="text-center" style="width: 120px;">Estado Contacto</th>
                                    <th class="text-center" style="width: 160px;">Tipo Gestión</th>
                                    <th class="text-center" style="width: 100px;">Acuerdo</th>
                                    <th class="text-center" style="width: 120px;">Fecha Acuerdo</th>
                                    <th class="text-center" style="width: 120px;">Monto</th>
                                    <th class="text-center" style="width: 120px;">Seguimiento</th>
                                    <th>Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for gestion in gestiones_cliente %}
                                <tr>
                                    <td class="text-center">{{ gestion.fecha_hora_gestion|date:"Y-m-d H:i" }}</td>
                                    <td class="text-center">{{ gestion.usuario_gestion.username|default:"N/A" }}</td>
                                    <td class="text-center">
                                        {% if gestion.canal_contacto == 'telefono' %}
                                            <span class="badge bg-warning" title="Teléfono"><i class="bi bi-telephone"></i></span>
                                        {% elif gestion.canal_contacto == 'whatsapp' %}
                                            <span class="badge bg-success" title="WhatsApp"><i class="bi bi-whatsapp"></i></span>
                                        {% elif gestion.canal_contacto == 'email' %}
                                            <span class="badge bg-primary" title="Email"><i class="bi bi-envelope"></i></span>
                                        {% elif gestion.canal_contacto == 'sms' %}
                                            <span class="badge bg-info" title="SMS"><i class="bi bi-chat"></i></span>
                                        {% else %}
                                            {{ gestion.get_canal_contacto_display|default:"N/A" }}
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if gestion.estado_contacto == 'contactado' %}
                                            <span class="badge bg-success">Contactado</span>
                                        {% elif gestion.estado_contacto == 'no_contactado' %}
                                            <span class="badge bg-warning">No Contactado</span>
                                        {% elif gestion.estado_contacto == 'numero_errado' %}
                                            <span class="badge bg-danger">Número Errado</span>
                                        {% else %}
                                            {{ gestion.get_estado_contacto_display|default:"N/A" }}
                                        {% endif %}
                                    </td>
                                    <td>{{ gestion.tipo_gestion_n1|default:"-" }}</td>
                                    <td class="text-center">
                                        {% if gestion.acuerdo_pago_realizado %}
                                            <span class="badge bg-success"><i class="bi bi-check-circle-fill"></i></span>
                                        {% else %}
                                            <span class="badge bg-secondary"><i class="bi bi-x-circle"></i></span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">{{ gestion.fecha_acuerdo|date:"Y-m-d"|default:"-" }}</td>
                                    <td class="text-end">{% if gestion.monto_acuerdo %}${{ gestion.monto_acuerdo|floatformat:0 }}{% else %}-{% endif %}</td>
                                    <td class="text-center">
                                        {% if gestion.seguimiento_requerido %}
                                            <span class="badge bg-info" title="Fecha: {{ gestion.fecha_proximo_seguimiento|date:'Y-m-d'|default:'No especificada' }}"><i class="bi bi-calendar-check"></i></span>
                                        {% else %}
                                            <span class="badge bg-secondary"><i class="bi bi-calendar-x"></i></span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div style="max-width: 300px; white-space: normal;">
                                            {% if gestion.observaciones_generales %}
                                                {{ gestion.observaciones_generales|linebreaksbr }}
                                            {% elif gestion.observaciones_acuerdo and gestion.acuerdo_pago_realizado %}
                                                <span class="text-muted">Acuerdo:</span> {{ gestion.observaciones_acuerdo|linebreaksbr }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mt-2">No hay gestiones registradas para este cliente.</p>
                {% endif %}
            </div>
        </div>

    </div> <!-- Fin Tab Content Principal -->
</div> <!-- Fin Div Principal del Bloque de Contenido -->
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Código para depurar el envío del formulario
    const formularioGestion = document.querySelector('form.needs-validation');
    const botonGuardar = document.getElementById('btn_guardar_gestion');
    
    // Verificar si los elementos existen
    if (formularioGestion) {
        console.log('Formulario de gestión encontrado, añadiendo evento para depuración');
        
        // Detectar clic en el botón de guardar
        if (botonGuardar) {
            console.log('Botón de guardar encontrado, añadiendo listener de clic');
            botonGuardar.addEventListener('click', function(event) {
                console.log('=== CLIC EN BOTÓN GUARDAR DETECTADO ===');
                console.log('Tipo de evento:', event.type);
                console.log('Target:', event.target);
                console.log('Propiedades del botón:', {
                    id: this.id,
                    name: this.name,
                    type: this.type,
                    disabled: this.disabled,
                    className: this.className
                });
                
                // No prevenimos el evento para que continue y se ejecute el submit
                // Solo estamos registrando que se hizo clic
            });
        } else {
            console.error('CRÍTICO: Botón de guardar NO encontrado');
        }

        // Depurar envío del formulario
        formularioGestion.addEventListener('submit', function(event) {
            // Prevenir temporalmente el envío para poder ver los datos
            event.preventDefault();
            
            console.log('=== DEPURACIÓN: EVENTO SUBMIT DEL FORMULARIO ===');
            console.log('Tipo de evento:', event.type);
            console.log('¿Event.defaultPrevented?', event.defaultPrevented);
            console.log('Form action:', this.action || 'No tiene action específico');
            console.log('Form method:', this.method || 'No tiene method específico');
            console.log('Form enctype:', this.enctype);
            
            const formData = new FormData(this);
            
            // Verificar campos clave
            console.log('\n=== CAMPOS CLAVE DEL FORMULARIO ===');
            console.log('¿Existe campo cliente?', formData.has('cliente'), formData.get('cliente'));
            console.log('¿Existe campo guardar_gestion?', formData.has('guardar_gestion'), formData.get('guardar_gestion'));
            console.log('¿Existe canal_contacto?', formData.has('canal_contacto'), formData.get('canal_contacto'));
            console.log('¿Existe estado_contacto?', formData.has('estado_contacto'), formData.get('estado_contacto'));
            console.log('¿Existe tipo_gestion_n1?', formData.has('tipo_gestion_n1'), formData.get('tipo_gestion_n1'));
            console.log('¿Existe csrfmiddlewaretoken?', formData.has('csrfmiddlewaretoken'));
            
            // Mostrar campos y valores
            console.log('\n=== TODOS LOS CAMPOS DEL FORMULARIO ===');
            const formDataObj = {};
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
                formDataObj[key] = value;
            }
            
            // Validar campos requeridos manualmente
            let camposVacios = [];
            let camposConError = formularioGestion.querySelectorAll('.invalid-feedback');
            if (camposConError.length > 0) {
                console.log('\n=== ERRORES DE VALIDACIÓN HTML ===');
                camposConError.forEach(campoError => {
                    console.log('Error encontrado:', campoError.textContent.trim());
                });
            }
            
            // Continuar con el envío
            console.log('\n=== ENVIANDO FORMULARIO EN 1 SEGUNDO ===');
            setTimeout(() => {
                console.log('Enviando formulario al servidor...');
                this.submit();
            }, 1000);
        });
    } else {
        console.error('No se encontró el formulario de gestión en la página');
    }
    
    // Ocultar los contenedores de acuerdo de pago y seguimiento al cargar la página
    const camposAcuerdo = document.getElementById('campos-acuerdo');
    const camposSeguimiento = document.getElementById('campos-seguimiento');
    
    if (camposAcuerdo) camposAcuerdo.style.display = 'none';
    if (camposSeguimiento) camposSeguimiento.style.display = 'none';
    
    // Función para mostrar/ocultar opciones en selectores dependientes
    function actualizarOpcionesVisibles(selectorPadre, selectorHijo) {
        const valorSeleccionado = selectorPadre.value;
        // Ocultar todas las opciones excepto la primera
        Array.from(selectorHijo.options).forEach((option, index) => {
            if (index === 0) return;
            option.style.display = 'none';
        });
        // Mostrar solo las opciones correspondientes al valor seleccionado
        let opcionesVisibles = 0;
        Array.from(selectorHijo.options).forEach(option => {
            if (option.getAttribute('data-parent') === valorSeleccionado) {
                option.style.display = '';
                opcionesVisibles++;
            }
        });
        // Resetear el valor del selector hijo
        selectorHijo.value = '';
        // Habilitar si hay opciones, deshabilitar si no
        selectorHijo.disabled = (opcionesVisibles === 0);
    }
    // Al cargar la página, asegúrate de habilitar los selects si hay opciones
    // Referencias a los campos de formulario (MOVIDAS ARRIBA)
    const estadoContactoSelect = document.getElementById('{{ gestion_form.estado_contacto.id_for_label }}');
    const tipoGestionN1Select = document.getElementById('{{ gestion_form.tipo_gestion_n1.id_for_label }}');
    const canalContactoSelect = document.getElementById('{{ gestion_form.canal_contacto.id_for_label }}');
    // const tipoGestionN2Select = document.getElementById('{{ gestion_form.tipo_gestion_n2.id_for_label }}'); // Descomentar si se usa

    // Al cargar la página, y después de declarar las constantes:
    if (!tipoGestionN1Select) {
        console.error("CRITICAL-INIT: El elemento select 'tipoGestionN1Select' (ID: {{ gestion_form.tipo_gestion_n1.id_for_label }}) NO fue encontrado en el DOM al inicializar.");
    } else {
        console.log("INIT: Elemento 'tipoGestionN1Select' (ID: {{ gestion_form.tipo_gestion_n1.id_for_label }}) encontrado correctamente.");
        // Habilitar el select si hay opciones y fue encontrado
        if (tipoGestionN1Select.options.length > 1) {
            tipoGestionN1Select.disabled = false;
        }
    }
    // if (tipoGestionN2Select && typeof tipoGestionN2Select !== 'undefined' && tipoGestionN2Select.options.length > 1) { // Si se usa tipoGestionN2Select
    //     tipoGestionN2Select.disabled = false;
    // }

    // Referencias a los contenedores de sección principales
    const acuerdoPagoSectionContainer = document.getElementById('acuerdo_pago_section_container');
    const seguimientoSectionContainer = document.getElementById('seguimiento_section_container');
    const comprobantePagoContainer = document.getElementById('comprobante_pago_container');
    const fechaPagoEfectivoContainer = document.getElementById('fecha_pago_efectivo_container');
    const urlTiposGestion = "{% url 'core:ajax_get_opciones_nivel2' %}";

    console.log('Elementos del DOM inicializados:', {
        canalContactoSelect,
        estadoContactoSelect,
        tipoGestionN1Select,
        acuerdoPagoSectionContainer,
        seguimientoSectionContainer,
        comprobantePagoContainer,
        fechaPagoEfectivoContainer
    });

    if (!estadoContactoSelect) console.error('ERROR: estadoContactoSelect no encontrado');
    if (!tipoGestionN1Select) console.error('ERROR: tipoGestionN1Select no encontrado');
    
    // Referencias a los campos de acuerdo de pago (el checkbox fue eliminado)
    const fechaAcuerdoGroup = document.getElementById('{{ gestion_form.fecha_acuerdo.id_for_label }}').closest('.mb-3');
    const montoAcuerdoGroup = document.getElementById('{{ gestion_form.monto_acuerdo.id_for_label }}').closest('.mb-3');
    const observacionesAcuerdoGroup = document.getElementById('{{ gestion_form.observaciones_acuerdo.id_for_label }}').closest('.mb-3');
    
    // Referencias a los campos de seguimiento (el checkbox fue eliminado)
    const camposSeguimientoDiv = document.getElementById('campos-seguimiento');
    
    // Establecer teléfono como opción por defecto en canal de contacto
    if (canalContactoSelect) {
        if (!canalContactoSelect.value) {
            canalContactoSelect.value = 'whatsapp';
        }
    }
    
    // Evento para cambio en estado de contacto
    if (estadoContactoSelect) {
        console.log('estadoContactoSelect encontrado. Añadiendo event listener.');
        estadoContactoSelect.addEventListener('change', function() {
            console.log('Estado contacto cambiado. ID:', this.value);
            const estadoContactoId = this.value;
            console.log('Estado de contacto seleccionado:', estadoContactoId);
            
            if (!tipoGestionN1Select) {
                console.error('CRITICAL: tipoGestionN1Select NO encontrado al inicio del evento change de estadoContactoSelect.');
                // return; // Podríamos detener la ejecución aquí si es crítico
            } else {
                console.log('tipoGestionN1Select SÍ encontrado al inicio del evento change.');
            }
            // Limpiar y deshabilitar tipoGestionN1Select antes de la carga.');
            
            // Limpiar y deshabilitar el selector de tipo de gestión
            if (tipoGestionN1Select) {
                tipoGestionN1Select.innerHTML = '';
                tipoGestionN1Select.disabled = true;
                console.log('tipoGestionN1Select limpiado y deshabilitado.');
            } else {
                console.error('ERROR: tipoGestionN1Select no encontrado al intentar limpiar/deshabilitar.');
                return; // Salir si el select no existe
            }
            
            if (estadoContactoId) {
                console.log(`Realizando fetch a: ${urlTiposGestion}?estado_contacto_id=${estadoContactoId}`);
                fetch(`${urlTiposGestion}?estado_contacto_id=${estadoContactoId}`)
                    .then(response => {
                        console.log('Respuesta de fetch recibida:', response);
                        if (!response.ok) {
                            console.error('Error en la respuesta de fetch:', response.status, response.statusText);
                            return response.text().then(text => { throw new Error('Respuesta de servidor no OK: ' + text); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Datos JSON recibidos para Tipo de Gestión:', data);
                        if (tipoGestionN1Select) {
                            updateSelectWithOptions(tipoGestionN1Select, data, 'Seleccione Tipo de Gestión');
                            tipoGestionN1Select.disabled = false;
                            console.log('Opciones de tipo de gestión cargadas y tipoGestionN1Select habilitado.');
                        } else {
                            console.error('ERROR: tipoGestionN1Select no encontrado al intentar actualizar opciones.');
                        }
                    })
                    .catch(error => {
                        console.error('Error en la petición AJAX para tipos de gestión o al procesar JSON:', error);
                        if (tipoGestionN1Select) {
                            tipoGestionN1Select.innerHTML = '<option value="">Error al cargar</option>'; // Mostrar error en el select
                            tipoGestionN1Select.disabled = false; // Habilitar para que el usuario vea el error
                        }
                    });
            } // Cierre del if (estadoContactoId)
        }); // Cierre del addEventListener
    } else {
        console.error('ERROR: estadoContactoSelect no encontrado, no se pudo añadir event listener.');
    }
    
    // Función para actualizar las opciones de un select (RESTAURADA)
    function updateSelectWithOptions(selectElement, options, defaultOptionText) {
        console.log('updateSelectWithOptions llamada con:', selectElement, options, defaultOptionText);
        if (!selectElement) {
            console.error('CRITICAL: selectElement es nulo en updateSelectWithOptions');
            return;
        }
        if (!Array.isArray(options)) {
            console.error('Error: las opciones no son un array.', options);
            // Mostrar un mensaje de error en el select
            selectElement.innerHTML = '<option value="">Error: Formato de opciones incorrecto</option>';
            return;
        }
        selectElement.innerHTML = ''; // Limpiar opciones existentes
        
        // Añadir opción por defecto
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = defaultOptionText;
        selectElement.appendChild(defaultOption);

        // Añadir nuevas opciones
        options.forEach(function(option) {
            const opt = document.createElement('option');
            opt.value = option.value;
            opt.textContent = option.label;
            selectElement.appendChild(opt);
        });
    }
    
    // Evento para cambio en tipo de gestión
    tipoGestionN1Select.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const tipoGestionValue = this.value;
        console.log(`tipoGestionN1Select CHANGED. Value: '${tipoGestionValue}', Text: '${selectedOption ? selectedOption.text : 'N/A'}'`);
        toggleFieldsBasedOnSelection(tipoGestionValue);
    });
    
    // Si hay valores preseleccionados, disparar el evento change para cargar las opciones
    if (estadoContactoSelect && estadoContactoSelect.value) {
        console.log('Estado de contacto tiene valor preseleccionado:', estadoContactoSelect.value, '. Disparando evento change.');
        estadoContactoSelect.dispatchEvent(new Event('change'));
        // Si también hay un valor en tipo de gestión, aplicar la lógica condicional
        if (tipoGestionN1Select && tipoGestionN1Select.value) {
            console.log('Tipo de gestión tiene valor preseleccionado:', tipoGestionN1Select.value, '. Aplicando lógica condicional.');
            toggleFieldsBasedOnSelection(tipoGestionN1Select.value);
        }
    }
    
    // --- INICIO FUNCIONES DE GESTIÓN DE SECCIONES ---
    function manageAcuerdoPagoSection(show) {
        const section = document.getElementById('acuerdo_pago_section_container');
        const fieldsContainer = document.getElementById('campos-acuerdo');
        const fechaAcuerdoInput = document.getElementById('{{ gestion_form.fecha_acuerdo.id_for_label }}');
        const montoAcuerdoInput = document.getElementById('{{ gestion_form.monto_acuerdo.id_for_label }}');
        const observacionesAcuerdoInput = document.getElementById('{{ gestion_form.observaciones_acuerdo.id_for_label }}');

        if (section) section.style.display = show ? 'block' : 'none';
        if (fieldsContainer) fieldsContainer.style.display = show ? 'block' : 'none';

        const inputsToManage = [fechaAcuerdoInput, montoAcuerdoInput, observacionesAcuerdoInput];
        inputsToManage.forEach(input => {
            if (input) input.disabled = !show;
        });

        if (!show) {
            inputsToManage.forEach(input => {
                if (input) input.value = '';
            });
        }
    }

    function manageSeguimientoSection(show) {
        console.log(`manageSeguimientoSection llamada con show: ${show}`);
        const section = document.getElementById('seguimiento_section_container');
        const fieldsContainer = document.getElementById('campos-seguimiento');
        if (!section) console.error('manageSeguimientoSection: No se encontró seguimiento_section_container');
        if (!fieldsContainer) console.error('manageSeguimientoSection: No se encontró campos-seguimiento');
        const fechaSeguimientoInput = document.getElementById('{{ gestion_form.fecha_proximo_seguimiento.id_for_label }}');
        const horaSeguimientoInput = document.getElementById('{{ gestion_form.hora_proximo_seguimiento.id_for_label }}');
        const observacionesGeneralesInput = document.getElementById('{{ gestion_form.observaciones_generales.id_for_label }}');

        if (section) section.style.display = show ? 'block' : 'none';
        if (fieldsContainer) fieldsContainer.style.display = show ? 'block' : 'none';

        const inputsToManage = [fechaSeguimientoInput, horaSeguimientoInput, observacionesGeneralesInput];
        inputsToManage.forEach(input => {
            if (input) input.disabled = !show;
        });

        if (!show) {
            inputsToManage.forEach(input => {
                if (input) input.value = '';
            });
        }
    }

    function manageComprobantePagoSection(show) {
        const section = document.getElementById('comprobante_pago_container'); // Este es el ID del col-md-4
        // fechaPagoEfectivoContainer está dentro de comprobante_pago_container, por lo que se mostrará/ocultará con su padre.
        const comprobantePagoInput = document.getElementById('{{ gestion_form.comprobante_pago.id_for_label }}');
        const fechaPagoEfectivoInput = document.getElementById('{{ gestion_form.fecha_pago_efectivo.id_for_label }}');

        if (section) section.style.display = show ? 'block' : 'none';

        const inputsToManage = [comprobantePagoInput, fechaPagoEfectivoInput];
        inputsToManage.forEach(input => {
            if (input) input.disabled = !show;
        });

        if (!show) {
            inputsToManage.forEach(input => {
                if (input) {
                    if (input.type === 'file') {
                        input.value = null; // Para campos de archivo
                    } else {
                        input.value = '';
                    }
                }
            });
        }
    }
    // --- FIN FUNCIONES DE GESTIÓN DE SECCIONES ---
    
    // Función para validar campos interdependientes
    function validateForm() {
        let isValid = true;
        let messages = [];
        
        // Validar que se haya seleccionado un estado de contacto
        if (!estadoContactoSelect || !estadoContactoSelect.value) {
            isValid = false;
            messages.push('Debe seleccionar un estado de contacto.');
            if (estadoContactoSelect) estadoContactoSelect.classList.add('is-invalid');
        } else {
            if (estadoContactoSelect) estadoContactoSelect.classList.remove('is-invalid');
        }

        // Validar que se haya seleccionado un tipo de gestión N1
        if (!tipoGestionN1Select || !tipoGestionN1Select.value) {
            isValid = false;
            messages.push('Debe seleccionar un tipo de gestión.');
            if (tipoGestionN1Select) tipoGestionN1Select.classList.add('is-invalid');
        } else {
            if (tipoGestionN1Select) tipoGestionN1Select.classList.remove('is-invalid');
        }

        // Validar campos de Acuerdo de Pago si la sección está visible
        const acuerdoSection = document.getElementById('acuerdo_pago_section_container');
        if (acuerdoSection && acuerdoSection.style.display !== 'none') {
            const fechaAcuerdoInput = document.getElementById('{{ gestion_form.fecha_acuerdo.id_for_label }}');
            const montoAcuerdoInput = document.getElementById('{{ gestion_form.monto_acuerdo.id_for_label }}');
            if (!fechaAcuerdoInput.value) {
                isValid = false; messages.push('Acuerdo: Debe ingresar la fecha del acuerdo.'); fechaAcuerdoInput.classList.add('is-invalid');
            } else { fechaAcuerdoInput.classList.remove('is-invalid'); }
            if (!montoAcuerdoInput.value || parseFloat(montoAcuerdoInput.value) <= 0) {
                isValid = false; messages.push('Acuerdo: Debe ingresar un monto válido.'); montoAcuerdoInput.classList.add('is-invalid');
            } else { montoAcuerdoInput.classList.remove('is-invalid'); }
        }

        // Validar campos de Seguimiento si la sección está visible
        const seguimientoSection = document.getElementById('seguimiento_section_container');
        if (seguimientoSection && seguimientoSection.style.display !== 'none') {
            const fechaSeguimientoInput = document.getElementById('{{ gestion_form.fecha_proximo_seguimiento.id_for_label }}');
            const horaSeguimientoInput = document.getElementById('{{ gestion_form.hora_proximo_seguimiento.id_for_label }}');
            if (!fechaSeguimientoInput.value) {
                isValid = false; messages.push('Seguimiento: Debe ingresar la fecha.'); fechaSeguimientoInput.classList.add('is-invalid');
            } else { fechaSeguimientoInput.classList.remove('is-invalid'); }
            if (!horaSeguimientoInput.value) {
                isValid = false; messages.push('Seguimiento: Debe ingresar la hora.'); horaSeguimientoInput.classList.add('is-invalid');
            } else { horaSeguimientoInput.classList.remove('is-invalid'); }
        }

        // Validar campos de Comprobante de Pago si la sección está visible
        const comprobanteSection = document.getElementById('comprobante_pago_container');
        if (comprobanteSection && comprobanteSection.style.display !== 'none') {
            const comprobantePagoInput = document.getElementById('{{ gestion_form.comprobante_pago.id_for_label }}');
            const fechaPagoEfectivoInput = document.getElementById('{{ gestion_form.fecha_pago_efectivo.id_for_label }}');
            // La validación del archivo es opcional aquí, podría ser más compleja (ej. verificar si se subió)
            // if (!comprobantePagoInput.value) {
            //     isValid = false; messages.push('Comprobante: Debe adjuntar un comprobante.'); comprobantePagoInput.classList.add('is-invalid');
            // } else { comprobantePagoInput.classList.remove('is-invalid'); }
            if (!fechaPagoEfectivoInput.value) {
                isValid = false; messages.push('Comprobante: Debe ingresar la fecha de pago efectivo.'); fechaPagoEfectivoInput.classList.add('is-invalid');
            } else { fechaPagoEfectivoInput.classList.remove('is-invalid'); }
        }

        if (!isValid) {
            alert('Por favor corrija los siguientes errores:\n- ' + messages.join('\n- '));
        }
        return isValid;
    }
    
    // Agregar validación al formulario
    const form = document.querySelector('#registrar-gestion form');
    form.addEventListener('submit', function(event) {
        if (!validateForm()) {
            event.preventDefault();
        }
    });
    
    // Configuración de los desplegables dependientes usando AJAX
    // La constante urlTiposGestion ya ha sido declarada y movida al inicio del DOMContentLoaded.
    // El addEventListener para estadoContactoSelect y la lógica de dispatchEvent ya están definidos anteriormente (around lines 800-900+)
    // por lo que este bloque if (estadoContactoSelect) { ... } que estaba aquí y contenía erróneamente
    // la declaración de fechaPagoEfectivoContainer y la definición de toggleFieldsBasedOnSelection
    // ya no es necesario en esta posición con ese contenido.
    // Si se necesita un if(estadoContactoSelect) para alguna lógica específica aquí, se debe añadir explícitamente.

    // Función para mostrar u ocultar secciones según la selección de tipo de gestión
    function toggleFieldsBasedOnSelection(tipoGestionValue) {
        console.log('toggleFieldsBasedOnSelection llamado con:', tipoGestionValue);
        // Ocultar todas las secciones primero
        manageAcuerdoPagoSection(false);
        manageSeguimientoSection(false);
        manageComprobantePagoSection(false);

        if (!tipoGestionValue) return; // Si no hay valor, todas permanecen ocultas

        switch (tipoGestionValue) {
            case 'PAGADO':
                manageComprobantePagoSection(true);
                break;
            case 'AP': // Acuerdo Pendiente
            case 'PP': // Promesa de Pago
                manageAcuerdoPagoSection(true);
                break;
            case 'SOLICITA_LLAMADA': // Solicita Llamada
                console.log("toggleFieldsBasedOnSelection: Entrando en caso 'SL' (Solicita Llamada)");
                manageSeguimientoSection(true);
                break;
            case 'NC': // Negociación en Curso
                console.log("toggleFieldsBasedOnSelection: Entrando en caso 'NC' (Negociación en Curso)");
                manageSeguimientoSection(true);
                break;
            // Añadir más casos según sea necesario
        }
    }
});
</script>
{% endblock %}